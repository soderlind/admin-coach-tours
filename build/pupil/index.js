(()=>{"use strict";var e,t,n={997(e){e.exports=window.wp.blocks}},r={};function o(e){var t=r[e];if(void 0!==t)return t.exports;var c=r[e]={exports:{}};return n[e](c,c.exports,o),c.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,o.t=function(n,r){if(1&r&&(n=this(n)),8&r)return n;if("object"==typeof n&&n){if(4&r&&n.__esModule)return n;if(16&r&&"function"==typeof n.then)return n}var c=Object.create(null);o.r(c);var s={};e=e||[null,t({}),t([]),t(t)];for(var i=2&r&&n;("object"==typeof i||"function"==typeof i)&&!~e.indexOf(i);i=t(i))Object.getOwnPropertyNames(i).forEach(e=>s[e]=()=>n[e]);return s.default=()=>n,o.d(c,s),c},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var c={};o.r(c),o.d(c,{activatePicker:()=>xe,addStep:()=>Ue,clearAiDraft:()=>Ge,clearEphemeralTour:()=>Xe,clearResolvedTarget:()=>Ie,createTour:()=>de,deactivatePicker:()=>Pe,deleteStep:()=>je,endTour:()=>he,fetchTour:()=>ae,fetchTours:()=>le,incrementResolutionAttempts:()=>Re,markStepComplete:()=>ke,nextStep:()=>fe,previousStep:()=>Ee,receiveEphemeralTour:()=>Ke,receiveTour:()=>se,receiveTours:()=>ce,reorderSteps:()=>qe,repeatStep:()=>ye,requestAiDraft:()=>He,requestAiTour:()=>Ye,resetCompletion:()=>Ae,saveTour:()=>ue,selectStep:()=>Be,setAiDraftError:()=>Fe,setAiDraftLoading:()=>Me,setAiDraftResult:()=>Ve,setAiTourError:()=>ze,setAiTourLoading:()=>$e,setCompletionSatisfied:()=>be,setCurrentStep:()=>Te,setCurrentTour:()=>ie,setLastError:()=>ve,setMode:()=>Se,setPendingChanges:()=>Le,setRecovering:()=>we,setResolvedTarget:()=>Ce,setSidebarOpen:()=>We,setToursError:()=>oe,setToursLoading:()=>re,skipStep:()=>_e,startEphemeralTour:()=>Qe,startPicking:()=>Oe,startTour:()=>me,stopPicking:()=>Ne,stopTour:()=>ge,updateStep:()=>De,updateTour:()=>pe});var s={};o.r(s),o.d(s,{getAiDraft:()=>Nt,getAiDraftError:()=>Ot,getAiDraftResult:()=>Pt,getAiTourError:()=>Dt,getCurrentStep:()=>lt,getCurrentStepIndex:()=>it,getCurrentTour:()=>st,getCurrentTourId:()=>ct,getEphemeralTour:()=>Ut,getLastError:()=>At,getMode:()=>mt,getPickingStepId:()=>Ct,getProgress:()=>pt,getResolutionAttempts:()=>bt,getResolvedTarget:()=>yt,getSelectedStep:()=>wt,getSelectedStepId:()=>It,getSkippedSteps:()=>Et,getTotalSteps:()=>at,getTour:()=>et,getTours:()=>Ze,getToursByEditor:()=>ot,getToursById:()=>Je,getToursByPostType:()=>rt,getToursError:()=>nt,hasNextStep:()=>ut,hasPendingChanges:()=>Rt,hasPreviousStep:()=>dt,isAiDraftLoading:()=>vt,isAiDrafting:()=>xt,isAiTourLoading:()=>Lt,isCompletionSatisfied:()=>ft,isEducatorMode:()=>ht,isEphemeralTourActive:()=>jt,isPickerActive:()=>kt,isPupilMode:()=>gt,isRecovering:()=>St,isSidebarOpen:()=>Bt,isTourActive:()=>Tt,isToursLoading:()=>tt,wasStepSkipped:()=>_t});var i={};o.r(i),o.d(i,{getTour:()=>Mt,getTours:()=>qt,getToursByPostType:()=>Ft});const l=window.wp.element,a=window.wp.data,u=window.wp.i18n,d=window.wp.components,p=window.wp.primitives,m=window.ReactJSXRuntime;var h=(0,m.jsx)(p.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,m.jsx)(p.Path,{d:"m14.5 6.5-1 1 3.7 3.7H4v1.6h13.2l-3.7 3.7 1 1 5.6-5.5z"})}),g=(0,m.jsx)(p.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,m.jsx)(p.Path,{d:"m13.06 12 6.47-6.47-1.06-1.06L12 10.94 5.53 4.47 4.47 5.53 10.94 12l-6.47 6.47 1.06 1.06L12 13.06l6.47 6.47 1.06-1.06L13.06 12Z"})});function T({step:e,stepIndex:t,totalSteps:n,tourTitle:r,targetElement:o,resolutionError:c,isApplyingPreconditions:s,onContinue:i,onRepeat:a,onPrevious:p,onNext:T,onStop:f}){const[E,_]=(0,l.useState)({x:20,y:20}),[y,S]=(0,l.useState)(!1),[b,A]=(0,l.useState)({x:0,y:0}),[k,C]=(0,l.useState)(0),I=(0,l.useRef)(null),w=t===n-1,R="manual"===e?.completion?.type;(0,l.useEffect)(()=>{if(!o||y)return;const e=()=>{if(!o?.isConnected)return;const e=o.getBoundingClientRect();let t={top:0,left:0};if(o.ownerDocument!==document){const e=document.querySelector('iframe[name="editor-canvas"]');if(e){const n=e.getBoundingClientRect();t={top:n.top,left:n.left}}}const n={top:e.top+t.top,bottom:e.bottom+t.top,left:e.left+t.left,right:e.right+t.left},r=320,c=200,s=20;let i,l;n.right+r+s<window.innerWidth?(i=n.right+s,l=n.top):n.left-r-s>0?(i=n.left-r-s,l=n.top):n.bottom+c+s<window.innerHeight?(i=Math.max(s,n.left),l=n.bottom+s):n.top-c-s>0?(i=Math.max(s,n.left),l=n.top-c-s):(i=window.innerWidth-r-s,l=window.innerHeight-c-s),i=Math.max(s,Math.min(i,window.innerWidth-r-s)),l=Math.max(s,Math.min(l,window.innerHeight-c-s)),_({x:i,y:l})};e();const t=()=>{y||e()};window.addEventListener("scroll",t,{passive:!0}),window.addEventListener("resize",t,{passive:!0});const n=o.ownerDocument,r=n?.defaultView;return r&&r!==window&&r.addEventListener("scroll",t,{passive:!0}),()=>{if(window.removeEventListener("scroll",t),window.removeEventListener("resize",t),r&&r!==window)try{r.removeEventListener("scroll",t)}catch(e){}}},[o,y,k]);const v=(0,l.useCallback)(e=>{if(e.target.closest("button"))return;S(!0);const t=I.current.getBoundingClientRect();A({x:e.clientX-t.left,y:e.clientY-t.top})},[]),x=(0,l.useCallback)(e=>{if(!y)return;const t=e.clientX-b.x,n=e.clientY-b.y,r=I.current.getBoundingClientRect(),o=window.innerWidth-r.width,c=window.innerHeight-r.height;_({x:Math.max(0,Math.min(t,o)),y:Math.max(0,Math.min(n,c))})},[y,b]),O=(0,l.useCallback)(()=>{S(!1)},[]);return(0,l.useEffect)(()=>{if(y)return document.addEventListener("mousemove",x),document.addEventListener("mouseup",O),()=>{document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",O)}},[y,x,O]),(0,m.jsxs)("div",{ref:I,className:"act-coach-panel",style:{position:"fixed",top:E.y,left:E.x,width:"320px",maxHeight:"400px",backgroundColor:"#fff",borderRadius:"8px",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.15)",zIndex:9999990,display:"flex",flexDirection:"column",cursor:y?"grabbing":"default"},onMouseDown:v,children:[(0,m.jsx)("div",{className:"act-panel-header",style:{padding:"12px 16px",borderBottom:"1px solid #e0e0e0",cursor:"grab",userSelect:"none"},children:(0,m.jsxs)(d.Flex,{justify:"space-between",align:"center",children:[(0,m.jsxs)(d.FlexBlock,{children:[(0,m.jsx)("strong",{className:"act-panel-title",children:e?.title||(0,u.__)("Step","admin-coach-tours")+` ${t+1}`}),(0,m.jsxs)("div",{className:"act-panel-progress",style:{fontSize:"12px",color:"#666"},children:[`${t+1} / ${n}`,r&&` â€¢ ${r}`]})]}),(0,m.jsx)(d.FlexItem,{children:(0,m.jsx)(d.Button,{icon:g,label:(0,u.__)("Close tour","admin-coach-tours"),onClick:f,size:"small"})})]})}),(0,m.jsx)("div",{className:"act-panel-body",style:{padding:"16px",flex:1,overflow:"auto"},children:s?(0,m.jsxs)("div",{className:"act-panel-loading",children:[(0,m.jsx)(d.Spinner,{}),(0,m.jsx)("span",{children:(0,u.__)("Preparingâ€¦","admin-coach-tours")})]}):c?(0,m.jsxs)("div",{className:"act-panel-error",children:[(0,m.jsx)("p",{children:(0,u.__)("Could not find the target element. The UI may have changed.","admin-coach-tours")}),(0,m.jsx)(d.Button,{variant:"secondary",onClick:a,children:(0,u.__)("Try Again","admin-coach-tours")})]}):(0,m.jsx)(m.Fragment,{children:e?.content&&(0,m.jsx)("div",{className:"act-panel-content",dangerouslySetInnerHTML:{__html:e.content}})})}),(0,m.jsx)("div",{className:"act-panel-footer",style:{padding:"12px 16px",borderTop:"1px solid #e0e0e0"},children:(0,m.jsx)("div",{className:"act-panel-controls",children:(0,m.jsx)(d.Flex,{justify:"flex-end",align:"center",children:(0,m.jsx)(d.FlexItem,{children:R||w?(0,m.jsx)(d.Button,{variant:"primary",onClick:i,disabled:s||!!c,size:"small",children:w?(0,u.__)("Finish","admin-coach-tours"):(0,u.__)("Continue","admin-coach-tours")}):(0,m.jsx)(d.Button,{icon:h,label:(0,u.__)("Next","admin-coach-tours"),onClick:T,disabled:s||!!c,size:"small"})})})})})]})}const f={boxShadow:"0 0 0 4px #007cba, 0 0 0 9999px rgba(0, 0, 0, 0.5)",borderRadius:"4px",transition:"all 0.3s ease"};class E{constructor(e={}){this.options={usePulse:!0,overlayColor:"rgba(0, 0, 0, 0.5)",highlightColor:"#007cba",transitionDuration:300,...e},this.spotlightElement=null,this.targetElement=null,this.resizeObserver=null,this.styleElement=null,this._isAnimating=!1,this._init()}_init(){this.styleElement=document.createElement("style"),this.styleElement.textContent="\n@keyframes act-pulse {\n\t0% {\n\t\tbox-shadow: 0 0 0 4px #007cba, 0 0 0 9999px rgba(0, 0, 0, 0.5);\n\t}\n\t50% {\n\t\tbox-shadow: 0 0 0 8px rgba(0, 124, 186, 0.5), 0 0 0 9999px rgba(0, 0, 0, 0.5);\n\t}\n\t100% {\n\t\tbox-shadow: 0 0 0 4px #007cba, 0 0 0 9999px rgba(0, 0, 0, 0.5);\n\t}\n}\n",document.head.appendChild(this.styleElement),this.spotlightElement=document.createElement("div"),this.spotlightElement.className="act-highlighter-spotlight",this.spotlightElement.setAttribute("aria-hidden","true"),Object.assign(this.spotlightElement.style,{position:"fixed",pointerEvents:"none",zIndex:9999980,...f}),this.spotlightElement.style.display="none",document.body.appendChild(this.spotlightElement),this.resizeObserver=new ResizeObserver(()=>{this._updatePosition()})}highlight(e){e&&e.isConnected?this.targetElement!==e&&(this.targetElement&&(this.resizeObserver.unobserve(this.targetElement),this._removeScrollListeners()),this.targetElement=e,this.resizeObserver.observe(e),this._updatePosition(),this.spotlightElement.style.display="block",this.options.usePulse&&!this._isAnimating&&(this.spotlightElement.style.animation="act-pulse 2s infinite",this._isAnimating=!0),this._addScrollListeners()):this.clear()}_updatePosition(){if(!this.targetElement||!this.spotlightElement)return;const e=this.targetElement.getBoundingClientRect();let t={top:0,left:0};const n=this.targetElement.ownerDocument;if(n!==document){const e=document.querySelectorAll("iframe");for(const r of e)if(r.contentDocument===n){const e=r.getBoundingClientRect();t={top:e.top,left:e.left};break}}Object.assign(this.spotlightElement.style,{top:e.top+t.top-4+"px",left:e.left+t.left-4+"px",width:`${e.width+8}px`,height:`${e.height+8}px`})}_addScrollListeners(){this._scrollHandler=()=>{this._updatePosition()},this._scrollWindows=[];let e=this.targetElement?.parentElement;for(;e;)e.scrollHeight>e.clientHeight&&e.addEventListener("scroll",this._scrollHandler,{passive:!0}),e=e.parentElement;const t=this.targetElement?.ownerDocument,n=t?.defaultView;n&&n!==window&&(n.addEventListener("scroll",this._scrollHandler,{passive:!0}),n.addEventListener("resize",this._scrollHandler,{passive:!0}),this._scrollWindows.push(n)),window.addEventListener("scroll",this._scrollHandler,{passive:!0}),window.addEventListener("resize",this._scrollHandler,{passive:!0}),this._scrollWindows.push(window)}_removeScrollListeners(){if(!this._scrollHandler)return;let e=this.targetElement?.parentElement;for(;e;)e.removeEventListener("scroll",this._scrollHandler),e=e.parentElement;if(this._scrollWindows){for(const e of this._scrollWindows)try{e.removeEventListener("scroll",this._scrollHandler),e.removeEventListener("resize",this._scrollHandler)}catch(e){}this._scrollWindows=[]}this._scrollHandler=null}clear(){this.targetElement&&(this.resizeObserver.unobserve(this.targetElement),this._removeScrollListeners(),this.targetElement=null),this.spotlightElement&&(this.spotlightElement.style.display="none",this.spotlightElement.style.animation="none",this._isAnimating=!1)}async transitionTo(e){this.targetElement?(this.targetElement&&(this.resizeObserver.unobserve(this.targetElement),this._removeScrollListeners()),this.targetElement=e,e&&e.isConnected?(this.resizeObserver.observe(e),this._addScrollListeners(),await new Promise(e=>{requestAnimationFrame(()=>{this._updatePosition(),setTimeout(e,this.options.transitionDuration)})})):this.clear()):this.highlight(e)}setStyle(e){if(!this.spotlightElement)return;const t={default:"#007cba",success:"#00a32a",warning:"#dba617",error:"#d63638"},n=t[e]||t.default;this.spotlightElement.style.boxShadow=`0 0 0 4px ${n}, 0 0 0 9999px rgba(0, 0, 0, 0.5)`}async flash(){this.spotlightElement&&(this.setStyle("success"),await new Promise(e=>{setTimeout(()=>{this.setStyle("default"),e()},300)}))}destroy(){this.clear(),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.spotlightElement&&this.spotlightElement.parentNode&&(this.spotlightElement.parentNode.removeChild(this.spotlightElement),this.spotlightElement=null),this.styleElement&&this.styleElement.parentNode&&(this.styleElement.parentNode.removeChild(this.styleElement),this.styleElement=null)}}function _(e){if(!e)return!1;if(!e.isConnected)return!1;const t=window.getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility||"0"===t.opacity)return!1;const n=e.getBoundingClientRect();return 0!==n.width||0!==n.height}function y(e){const t=window.wp?.data;if(!t)return console.log("[ACT isWithinSelectedBlock] wp.data not available"),!0;const n=t.select("core/block-editor");if(!n)return console.log("[ACT isWithinSelectedBlock] core/block-editor not available"),!0;let r=n.getSelectedBlockClientId();if(console.log("[ACT isWithinSelectedBlock] Selected block clientId:",r),!r&&window.__actLastAppearedBlockClientId&&(r=window.__actLastAppearedBlockClientId,console.log("[ACT isWithinSelectedBlock] Using last appeared block:",r)),!r)return console.log("[ACT isWithinSelectedBlock] No block to scope to, allowing element"),!0;const o=(e.ownerDocument||document).querySelector(`[data-block="${r}"]`);if(!o)return console.log("[ACT isWithinSelectedBlock] Target block element not found in DOM"),!0;const c=o.contains(e);return console.log("[ACT isWithinSelectedBlock] Element within target block:",c),c}function S(e,t){if(!t)return!0;const n=(e.ownerDocument||document).querySelector(t);return!!n&&n.contains(e)}function b(e,t=document){try{return Array.from(t.querySelectorAll(e))}catch{return[]}}function A(e,t=document){switch(e.type){case"css":return b(e.value,t);case"role":return function(e,t=document){const[n,r]=e.split(":").map(e=>e.trim()),o=Array.from(t.querySelectorAll(`[role="${n}"]`)),c={button:'button, input[type="button"], input[type="submit"]',textbox:'input[type="text"], input:not([type]), textarea',link:"a[href]",checkbox:'input[type="checkbox"]',radio:'input[type="radio"]',listbox:"select",option:"option",heading:"h1, h2, h3, h4, h5, h6",img:"img[alt]",navigation:"nav",main:"main",complementary:"aside",banner:"header",contentinfo:"footer",search:'[role="search"]',form:"form",region:"section[aria-label], section[aria-labelledby]",tab:'[role="tab"]',tabpanel:'[role="tabpanel"]',tablist:'[role="tablist"]',menu:'[role="menu"]',menuitem:'[role="menuitem"]',dialog:'dialog, [role="dialog"]'};let s=[];c[n]&&(s=Array.from(t.querySelectorAll(c[n])));const i=[...o,...s];return r?i.filter(e=>{const t=function(e){if(e.getAttribute("aria-label"))return e.getAttribute("aria-label");const t=e.getAttribute("aria-labelledby");if(t){const e=document.getElementById(t);if(e)return e.textContent?.trim()||""}if(e.id){const t=document.querySelector(`label[for="${e.id}"]`);if(t)return t.textContent?.trim()||""}return e.getAttribute("title")?e.getAttribute("title"):"BUTTON"===e.tagName||"A"===e.tagName||"button"===e.getAttribute("role")?e.textContent?.trim()||"":"INPUT"===e.tagName&&e.value?e.value:""}(e);return t&&t.toLowerCase().includes(r.toLowerCase())}):i}(e.value,t);case"testid":case"testId":return function(e,t=document){return Array.from(t.querySelectorAll(`[data-testid="${e}"]`))}(e.value,t);case"dataattribute":case"dataAttribute":return function(e,t=document){const[n,r]=e.split(":").map(e=>e.trim()),o=r?`[data-${n}="${r}"]`:`[data-${n}]`;try{return Array.from(t.querySelectorAll(o))}catch{return[]}}(e.value,t);case"arialabel":case"ariaLabel":return function(e,t=document){return Array.from(t.querySelectorAll("[aria-label]")).filter(t=>{const n=t.getAttribute("aria-label");return n&&n.toLowerCase().includes(e.toLowerCase())})}(e.value,t);case"contextual":return function(e,t=document){const n=e.split(">>").map(e=>e.trim());if(2===n.length){const[e,r]=n,o=t.querySelector(e);return o?Array.from(o.querySelectorAll(r)):[]}return b(e)}(e.value,t);case"wpBlock":case"wpblock":return function(e,t=document){if("inserted"===e||e.startsWith("inserted:")){const n="inserted"===e?"act-inserted-block":e.substring(9),r=window.__actInsertedBlocks;if(console.log("[ACT findByWpBlock] Looking for inserted block, markerId:",n,"map exists:",!!r,"has key:",r?.has?.(n)),r?.has?.(n)){const e=r.get(n);console.log("[ACT findByWpBlock] Looking for inserted block:",n,"clientId:",e);let o=t.querySelector(`[data-block="${e}"]`);if(!o){const n=document.querySelector('iframe[name="editor-canvas"]'),r=n?.contentDocument;r&&r!==t&&(o=r.querySelector(`[data-block="${e}"]`),console.log("[ACT findByWpBlock] Searched iframe, found:",!!o))}if(o||t===document||(o=document.querySelector(`[data-block="${e}"]`),console.log("[ACT findByWpBlock] Searched main doc, found:",!!o)),o)return console.log("[ACT findByWpBlock] Found inserted block element"),[o]}return console.log("[ACT findByWpBlock] Inserted block not found for marker:",n,"Available markers:",r?Array.from(r.keys()):"none"),[]}const n=window.wp?.data;if(!n)return console.log("[ACT findByWpBlock] wp.data not available"),[];const r=n.select("core/block-editor");if(!r)return console.log("[ACT findByWpBlock] core/block-editor store not available"),[];const o=r.getBlocks();console.log("[ACT findByWpBlock] Found",o.length,"blocks in editor");let c=null;if("first"===e)c=o[0]?.clientId;else if("last"===e)c=o[o.length-1]?.clientId;else if("selected"===e)c=r.getSelectedBlockClientId();else if(e.startsWith("type:")){const t=e.substring(5).split(":"),n=t[0],r=t[1]?parseInt(t[1],10):0,s=o.filter(e=>e.name===n);console.log("[ACT findByWpBlock] Looking for type:",n,"- found",s.length),c=s[r]?.clientId}else if(e.startsWith("nth:")){const t=parseInt(e.substring(4),10);c=o[t]?.clientId}if(!c)return console.log("[ACT findByWpBlock] No matching block found for:",e),[];console.log("[ACT findByWpBlock] Target clientId:",c);const s=t.querySelector(`[data-block="${c}"]`);return s?(console.log("[ACT findByWpBlock] Found element:",s.tagName),[s]):(console.log("[ACT findByWpBlock] Element not found in DOM"),[])}(e.value,t);default:return[]}}function k(e,t,n){let r=t.weight||50;return e.id&&(r+=20),e.getAttribute("data-testid")&&(r+=15),n?.withinContainer&&S(e,n.withinContainer)&&(r+=10),y(e)&&(r+=100),_(e)&&(r+=5),r}function C(e){if(console.log("[ACT resolveTarget] Starting resolution",e),!e||!e.locators||0===e.locators.length)return console.log("[ACT resolveTarget] No locators provided"),{success:!1,error:"No locators provided"};const t=e.constraints||{};console.log("[ACT resolveTarget] Constraints:",t);const n=t.inEditorIframe||t.withinContainer&&[".editor-styles-wrapper",".block-editor-block-list__layout"].includes(t.withinContainer);console.log("[ACT resolveTarget] shouldSearchIframe:",n);let r=document;if(n){const e=function(){const e=document.querySelector('iframe[name="editor-canvas"]');return e?.contentDocument||null}();if(console.log("[ACT resolveTarget] iframeDoc:",e?"found":"NOT FOUND"),!e)return{success:!1,error:"Editor iframe not found"};r=e}const o=[...e.locators].sort((e,t)=>e.fallback!==t.fallback?e.fallback?1:-1:(t.weight||50)-(e.weight||50)),c=o.filter(e=>!e.fallback),s=o.filter(e=>e.fallback);console.log("[ACT resolveTarget] Trying",c.length,"primary +",s.length,"fallback locators");for(const e of[...c,...s]){let n=A(e,r);if(console.log("[ACT resolveTarget] Locator",e.type,":",e.value.substring(0,50),"-> found",n.length,"raw matches"),!1!==t.visible&&(n=n.filter(_),console.log("[ACT resolveTarget]   After visibility filter:",n.length)),t.scopeToSelectedBlock&&(n=n.filter(y),console.log("[ACT resolveTarget]   After selectedBlock filter:",n.length)),t.withinContainer&&(n=n.filter(e=>S(e,t.withinContainer)),console.log("[ACT resolveTarget]   After container filter:",n.length)),0===n.length)continue;if(1===n.length)return console.log("[ACT resolveTarget] SUCCESS! Found element with",e.type),{success:!0,element:n[0],usedLocator:e};if("number"==typeof t.index&&n[t.index])return{success:!0,element:n[t.index],usedLocator:e};console.log("[ACT resolveTarget] Multiple matches (",n.length,"), disambiguating by specificity...");const o=n.map(n=>({element:n,score:k(n,e,t)}));return o.sort((e,t)=>t.score-e.score),console.log("[ACT resolveTarget] Scores:",o.map(e=>e.score)),{success:!0,element:o[0].element,usedLocator:e}}return console.log("[ACT resolveTarget] FAILED - No matching element found after trying all locators"),{success:!1,error:"No matching element found"}}async function I(e,t=2e3){const n=Date.now();return new Promise(r=>{const o=()=>{const c=document.querySelector(e);c?r(c):Date.now()-n>t?r(null):requestAnimationFrame(o)};o()})}async function w(e,t=2e3){const n=Date.now();return new Promise(r=>{const o=()=>{try{if(e())return void r(!0)}catch{}Date.now()-n>t?r(!1):requestAnimationFrame(o)};o()})}const R=new Map;window.__actInsertedBlocks=R;const v=new Map;let x=0;function O(){R.clear(),v.clear(),x=0,delete window.__actLastAppearedBlockClientId,console.log("[ACT clearInsertedBlocks] Cleared all tracking")}function P(e,t,n){v.has(e)||v.set(e,{}),v.get(e)[t]=n}async function N(e){await new Promise(e=>setTimeout(e,100));const t=document.querySelector('iframe[name="editor-canvas"]'),n=t?.contentDocument||document,r=n.querySelector(`[data-block="${e}"]`);if(!r)return console.warn("[ACT focusBlockElement] Block element not found:",e),!1;const o=['[contenteditable="true"]',".block-editor-rich-text__editable","textarea",'input[type="text"]',"input:not([type])"];let c=null;for(const e of o)if(c=r.querySelector(e),c)break;if(c||(c=r),c.scrollIntoView({behavior:"smooth",block:"center"}),c.focus(),"true"===c.getAttribute("contenteditable")){const e=n.getSelection(),t=n.createRange();t.selectNodeContents(c),t.collapse(!1),e?.removeAllRanges(),e?.addRange(t)}return console.log("[ACT focusBlockElement] Focused:",c.tagName,c.className),!0}const B={ensureEditor:async function(){const e=(0,a.select)("core/block-editor");return!!e&&w(()=>{const t=e.getBlocks?.();return void 0!==t})},ensureSidebarOpen:async function(e=null){const t=(0,a.select)("core/edit-post"),n=(0,a.dispatch)("core/edit-post");if(!t||!n){const t=(0,a.select)("core/interface"),n=(0,a.dispatch)("core/interface");if(t&&n){const r=t.getActiveComplementaryArea?.("core/edit-post");return r||await(n.enableComplementaryArea?.("core/edit-post",e||"edit-post/document")),w(()=>!!t.getActiveComplementaryArea?.("core/edit-post"))}return!1}if(t.isEditorSidebarOpened?.()||t.isPluginSidebarOpened?.())return!0;try{return e?await(n.openGeneralSidebar?.(e)):await(n.openGeneralSidebar?.("edit-post/document")),w(()=>t.isEditorSidebarOpened?.())}catch{return!1}},ensureSidebarClosed:async function(){const e=(0,a.select)("core/edit-post"),t=(0,a.dispatch)("core/edit-post");if(!e||!t){const e=(0,a.select)("core/interface"),t=(0,a.dispatch)("core/interface");if(e&&t){const n=e.getActiveComplementaryArea?.("core/edit-post");return n&&await(t.disableComplementaryArea?.("core/edit-post")),w(()=>!e.getActiveComplementaryArea?.("core/edit-post"))}return!1}const n=e.isEditorSidebarOpened?.();if(!n)return!0;try{return await(t.closeGeneralSidebar?.()),w(()=>!e.isEditorSidebarOpened?.())}catch{return!1}},selectSidebarTab:async function(e){const t=(0,a.dispatch)("core/edit-post");if(!t)return!1;const n={document:"edit-post/document",post:"edit-post/document",block:"edit-post/block"}[e]||e;try{return await(t.openGeneralSidebar?.(n)),w(()=>{const e=(0,a.select)("core/edit-post");return e?.getActiveGeneralSidebarName?.()===n})}catch{return!1}},openInserter:async function(){const e=(0,a.select)("core/edit-post"),t=(0,a.dispatch)("core/edit-post");if(e?.isInserterOpened?.())return!0;try{return await(t?.setIsInserterOpened?.(!0)),w(()=>e?.isInserterOpened?.())}catch{const e=document.querySelector('.edit-post-header-toolbar__inserter-toggle, button[aria-label*="inserter"], button[aria-label*="Add block"]');return!!e&&(e.click(),I(".block-editor-inserter__content, .editor-inserter__content").then(e=>!!e))}},closeInserter:async function(){const e=(0,a.select)("core/edit-post"),t=(0,a.dispatch)("core/edit-post");if(!e?.isInserterOpened?.())return!0;try{return await(t?.setIsInserterOpened?.(!1)),w(()=>!e?.isInserterOpened?.())}catch{return!1}},selectBlock:async function(e){const t=(0,a.dispatch)("core/block-editor");if(!t||!e)return!1;try{return await(t.selectBlock?.(e)),w(()=>{const t=(0,a.select)("core/block-editor");return t?.getSelectedBlockClientId?.()===e})}catch{return!1}},focusElement:async function(e){const t=await I(e);if(!t)return!1;try{return t.focus(),document.activeElement===t}catch{return!1}},scrollIntoView:async function(e){const t=await I(e);if(!t)return!1;try{return t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),await new Promise(e=>setTimeout(e,300)),!0}catch{return!1}},openModal:async function(e,t){if(document.querySelector(t))return!0;const n=await I(e);return!!n&&(n.click(),I(t).then(e=>!!e))},closeModal:async function(e){const t=document.querySelector(e);if(!t)return!0;const n=t.querySelector('button[aria-label="Close"], .components-modal__header button, .components-popover__close');return n?(n.click(),w(()=>!document.querySelector(e))):(document.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape",code:"Escape",bubbles:!0})),w(()=>!document.querySelector(e)))},insertBlock:async function(e="core/paragraph",t={},n="act-inserted-block"){console.log("[ACT insertBlock] Called with:",{blockName:e,markerId:n,currentStepIndex:x}),console.log("[ACT insertBlock] insertedBlocks map:",Array.from(R.entries())),console.log("[ACT insertBlock] insertedBlocksByStep:",Array.from(v.entries()));try{const{createBlock:r}=await Promise.resolve().then(o.t.bind(o,997,23)),c=(0,a.dispatch)("core/block-editor"),s=(0,a.select)("core/block-editor");if(!c||!r)return console.warn("[ACT insertBlock] Block editor not available"),!1;const i=function(e,t){const n=v.get(e);return n&&n[t]?n[t]:null}(x,n);if(console.log("[ACT insertBlock] stepClientId from getStepInsertedBlock:",i),i){const e=s.getBlock(i);if(console.log("[ACT insertBlock] existingBlock from store:",e?.name),e)return await c.selectBlock(i),await N(i),console.log("[ACT insertBlock] Reusing step block:",i,"for step:",x),!0;const t=document.querySelector('iframe[name="editor-canvas"]');if((t?.contentDocument||document).querySelector(`[data-block="${i}"]`))return await c.selectBlock(i),await N(i),console.log("[ACT insertBlock] Block still in DOM, reusing:",i),!0;console.log("[ACT insertBlock] Block not in store or DOM, checking for any existing blocks of this type")}if(console.log("[ACT insertBlock] Checking global map for:",n,"has:",R.has(n)),R.has(n)){const e=R.get(n),t=s.getBlock(e);if(console.log("[ACT insertBlock] existingBlock from global map:",t?.name),t)return await c.selectBlock(e),await N(e),P(x,n,e),console.log("[ACT insertBlock] Reusing existing block:",e),!0;const r=document.querySelector('iframe[name="editor-canvas"]');if((r?.contentDocument||document).querySelector(`[data-block="${e}"]`))return await c.selectBlock(e),await N(e),P(x,n,e),console.log("[ACT insertBlock] Block from global map still in DOM:",e),!0}const l=s.getBlocks()||[];console.log("[ACT insertBlock] Checking for existing blocks of type:",e,"found:",l.length,"total blocks"),console.log("[ACT insertBlock] Block names in editor:",l.map(e=>e.name));const u=l.find(t=>t.name===e);if(u)return console.log("[ACT insertBlock] Found existing block of same type:",u.clientId),await c.selectBlock(u.clientId),await N(u.clientId),R.set(n,u.clientId),P(x,n,u.clientId),console.log("[ACT insertBlock] Reusing existing block of type:",e),!0;if(l.length>0){const t=l[l.length-1];console.log("[ACT insertBlock] Considering last block:",t.name,t.clientId);const r=["core/paragraph","core/heading","core/list","core/quote"],o=r.includes(e),s=r.includes(t.name);if(o&&s)return console.log("[ACT insertBlock] Reusing last text block instead of creating new:",t.clientId),await c.selectBlock(t.clientId),await N(t.clientId),R.set(n,t.clientId),P(x,n,t.clientId),!0}console.log("[ACT insertBlock] No existing block found, creating new one");const d={...t,metadata:{...t.metadata||{},actMarkerId:n}},p=r(e,d),m="";await c.insertBlock(p,void 0,m,!0),R.set(n,p.clientId),P(x,n,p.clientId);const h=await w(()=>{const e=document.querySelector('iframe[name="editor-canvas"]'),t=e?.contentDocument;return!!(t||document).querySelector(`[data-block="${p.clientId}"]`)},3e3);return h&&(await c.selectBlock(p.clientId),await N(p.clientId)),console.log("[ACT insertBlock] Inserted block:",p.clientId,"markerId:",n,"step:",x,"success:",h),h}catch(e){return console.error("[ACT insertBlock] Error:",e),!1}}};async function L(e){const{type:t,params:n={}}=e,r=B[t];if(!r)return{success:!1,error:`Unknown precondition type: ${t}`,type:t};try{let e;switch(t){case"ensureEditor":case"ensureSidebarClosed":case"openInserter":case"closeInserter":e=await r();break;case"ensureSidebarOpen":e=await r(n.sidebar);break;case"selectSidebarTab":e=await r(n.tab);break;case"selectBlock":e=await r(n.clientId);break;case"focusElement":case"scrollIntoView":e=await r(n.selector);break;case"openModal":e=await r(n.trigger,n.modal);break;case"closeModal":e=await r(n.modal);break;case"insertBlock":e=await r(n.blockName||"core/paragraph",n.attributes||{},n.markerId||"act-inserted-block");break;default:e=!1}return{success:e,type:t,error:e?null:`Precondition failed: ${t}`}}catch(e){return{success:!1,type:t,error:`Precondition error: ${e.message}`}}}async function D(e){if(!e||0===e.length)return{success:!0,results:[]};const t=[];let n=!0;for(const r of e){const e=await L(r);t.push(e),e.success||(n=!1)}return{success:n,results:t,failedPreconditions:t.filter(e=>!e.success)}}function U(e,t=0){return new Promise(n=>{let r=null,o=null,c=!1;const s=(e,t=!1)=>{c||(c=!0,r&&clearTimeout(r),o&&clearInterval(o),n({success:e,timedOut:t}))};t>0&&(r=setTimeout(()=>{s(!1,!0)},t));const i=()=>{try{e()&&s(!0)}catch{}};i(),c||(o=setInterval(i,100))})}function j(e,t={}){return new Promise(n=>{let r=!1,o=!1;const{timeout:c=0,gracePeriod:s=300}=t;let i=null;const l=()=>{e.removeEventListener("click",a,!0),e.ownerDocument!==document&&e.ownerDocument.removeEventListener("click",a,!0),i&&clearTimeout(i)},a=t=>{r||(o?(e===t.target||e.contains(t.target))&&(console.log("[ACT watchClickTarget] Click detected on target:",e.tagName),r=!0,l(),n({success:!0,event:"click"})):console.log("[ACT watchClickTarget] Ignoring click during grace period"))};e.addEventListener("click",a,{capture:!0}),e.ownerDocument!==document&&e.ownerDocument.addEventListener("click",a,{capture:!0}),setTimeout(()=>{o=!0,console.log("[ACT watchClickTarget] Armed after grace period, watching:",e.tagName,e.className)},s),c>0&&(i=setTimeout(()=>{r||(r=!0,l(),n({success:!1,timedOut:!0}))},c))})}function q(e,t={}){return new Promise(n=>{let r=!1;const{timeout:o=0,expectedValue:c,attributeName:s=null}=t;let i=null,l=null;const a=()=>{l&&l.disconnect(),e.removeEventListener("input",m),e.removeEventListener("change",h),i&&clearTimeout(i)},u=()=>s?e.getAttribute(s):"value"in e?e.value:e.isContentEditable?e.textContent:"checkbox"===e.type||"radio"===e.type?e.checked:e.textContent,d=u(),p=()=>{r||(()=>{const e=u();return void 0!==c?e===c:e!==d})()&&(r=!0,a(),n({success:!0,event:"valueChanged"}))},m=()=>p(),h=()=>p();e.addEventListener("input",m),e.addEventListener("change",h),l=new MutationObserver(()=>p()),l.observe(e,{attributes:!0,characterData:!0,subtree:!0,childList:!0}),o>0&&(i=setTimeout(()=>{r||(r=!0,a(),n({success:!1,timedOut:!0}))},o))})}function M(e={}){const{storeName:t,selector:n,args:r=[],expectedValue:o,comparator:c="equals",timeout:s=0}=e;return new Promise(e=>{let i=!1,l=null,u=null;const d=()=>{u&&u(),l&&clearTimeout(l)},p=(0,a.select)(t);if(!p||!p[n])return void e({success:!1,error:`Invalid store or selector: ${t}.${n}`});const m=()=>{i||(()=>{try{const e=p[n](...r);switch(c){case"equals":default:return e===o;case"notEquals":return e!==o;case"truthy":return!!e;case"falsy":return!e;case"contains":return(Array.isArray(e)||"string"==typeof e)&&e.includes(o);case"greaterThan":return e>o;case"lessThan":return e<o;case"lengthEquals":return e?.length===o;case"lengthGreaterThan":return e?.length>o}}catch{return!1}})()&&(i=!0,d(),e({success:!0,event:"wpDataChanged"}))};m(),i||(u=(0,a.subscribe)(()=>{m()})),s>0&&(l=setTimeout(()=>{i||(i=!0,d(),e({success:!1,timedOut:!0}))},s))})}function F(e={}){const{timeout:t=0}=e;let n=null,r=null,o=!1;return{promise:new Promise(e=>{n=e,t>0&&(r=setTimeout(()=>{o||(o=!0,e({success:!1,timedOut:!0}))},t))}),confirm:()=>{o||(o=!0,r&&clearTimeout(r),n({success:!0,event:"manual"}))},cancel:()=>{o||(o=!0,r&&clearTimeout(r),n({success:!1,cancelled:!0}))}}}function V(e,t={}){const{timeout:n=0}=t,r=()=>{const t=new Set;document.querySelectorAll(e).forEach(e=>{let n=e.getAttribute("data-block");if(!n){const t=e.closest("[data-block]");n=t?.getAttribute("data-block")}n&&t.add(n)});const n=document.querySelector('iframe[name="editor-canvas"]');return n?.contentDocument?.querySelectorAll(e).forEach(e=>{let n=e.getAttribute("data-block");if(!n){const t=e.closest("[data-block]");n=t?.getAttribute("data-block")}n&&t.add(n)}),t},o=r();return console.log("[ACT watchElementAppear] Existing matches:",o.size,"for selector:",e),U(()=>{const e=r();for(const t of e)if(!o.has(t))return window.__actNewlyAppearedBlockClientId=t,console.log("[ACT watchElementAppear] NEW element appeared:",t),!0;return!1},n).then(e=>(e.success&&window.__actNewlyAppearedBlockClientId&&(window.__actLastAppearedBlockClientId=window.__actNewlyAppearedBlockClientId,console.log("[ACT watchElementAppear] Tracked appeared block:",window.__actLastAppearedBlockClientId),delete window.__actNewlyAppearedBlockClientId),{...e,event:e.success?"elementAppeared":null}))}function G(e,t={}){const{timeout:n=0}=t;return U(()=>null===document.querySelector(e),n).then(e=>({...e,event:e.success?"elementDisappeared":null}))}function H(e,t={}){const{timeout:n=0,target:r=document}=t;return new Promise(t=>{let o=!1,c=null;const s=()=>{r.removeEventListener(e,i),c&&clearTimeout(c)},i=n=>{o||(o=!0,s(),t({success:!0,event:e,detail:n.detail}))};r.addEventListener(e,i,{once:!0}),n>0&&(c=setTimeout(()=>{o||(o=!0,s(),t({success:!1,timedOut:!0}))},n))})}function W(e){try{const t=(0,a.select)("core/block-editor");if(!t?.getBlocks)return!1;const n=t.getBlocks(),r=t=>{for(const n of t){if(n.name===e)return!0;if(n.innerBlocks?.length>0&&r(n.innerBlocks))return!0}return!1};return r(n)}catch(e){return console.warn("[ACT] Error checking for block type:",e),!1}}async function $(e,t,n=5e3){const r=t+1;if(r>=e.length)return{waited:!1};const o=function(e){if(!e?.target)return null;const{target:t}=e;if(t.constraints?.blockType)return t.constraints.blockType;const n=t.locators||[];for(const e of n){if("dataAttribute"===e.type&&"data-type"===e.attribute)return e.value;if("block"===e.type&&e.blockName)return e.blockName}for(const e of n)if("css"===e.type&&e.value){const t=e.value.match(/\[data-type=["']([^"']+)["']\]/);if(t)return t[1];const n=e.value.match(/\.wp-block-(\w+)/);if(n)return`core/${n[1]}`}return null}(e[r]);if(!o)return console.log("[ACT waitForNextStepBlock] Next step does not expect a specific block"),{waited:!1};if(console.log("[ACT waitForNextStepBlock] Next step expects block:",o),W(o))return console.log("[ACT waitForNextStepBlock] Block already exists"),{waited:!1,blockType:o};const c=await function(e,t=5e3){return new Promise(n=>{if(W(e))return console.log("[ACT waitForBlock] Block already exists:",e),void n({success:!0});console.log("[ACT waitForBlock] Waiting for block:",e);let r=null,o=null,c=!1;const s=(e,t=!1)=>{c||(c=!0,r&&clearTimeout(r),o&&o(),n({success:e,timedOut:t}))};t>0&&(r=setTimeout(()=>{console.log("[ACT waitForBlock] Timeout waiting for:",e),s(!1,!0)},t)),o=(0,a.subscribe)(()=>{W(e)&&(console.log("[ACT waitForBlock] Block appeared:",e),s(!0))})})}(o,n);return{waited:!0,blockType:o,success:c.success,timedOut:c.timedOut}}const z="admin-coach-tours";function K(){console.log("[ACT TourRunner] Component function called");const[e,t]=(0,l.useState)(null),[n,r]=(0,l.useState)(null),[o,c]=(0,l.useState)(null),[s,i]=(0,l.useState)(!1),[u,d]=(0,l.useState)(0),p=(0,l.useRef)(null),h=(0,l.useRef)(null),g=(0,l.useRef)(null),{isPlaying:f,currentTour:_,currentStep:y,stepIndex:S,totalSteps:b}=(0,a.useSelect)(e=>{const t=e(z),n={isPlaying:t.isPupilMode(),currentTour:t.getCurrentTour(),currentStep:t.getCurrentStep(),stepIndex:t.getCurrentStepIndex()||0,totalSteps:t.getTotalSteps()||0};return console.log("[ACT TourRunner] useSelect:",n),n},[]),{stopTour:A,nextStep:k,previousStep:I,repeatStep:w}=(0,a.useDispatch)(z);(0,l.useEffect)(()=>(p.current||(p.current=new E),()=>{p.current&&(p.current.destroy(),p.current=null)}),[]),(0,l.useEffect)(()=>{if(!f||!y)return p.current&&p.current.clear(),t(null),void O();let e=!0,n=null;const o=h.current;return(async()=>{if(r(null),i(!0),g.current?.cancel&&(console.log("[ACT TourRunner] Cancelling previous completion watcher"),g.current.cancel(),g.current=null),null!==o&&o!==S&&await async function(e){console.log("[ACT onLeaveStep] Leaving step:",e);const t=(0,a.dispatch)("core/block-editor"),n=(0,a.select)("core/block-editor");if(!t||!n)return;const r=n.getSelectedBlockClientId?.();if(r)try{await(t.clearSelectedBlock?.()),console.log("[ACT onLeaveStep] Deselected block:",r)}catch(e){console.warn("[ACT onLeaveStep] Could not deselect block:",e)}}(o),await async function(e){var t;console.log("[ACT onEnterStep] Entering step:",e),x=t=e,console.log("[ACT setCurrentStepIndex]",t)}(S),h.current=S,console.log("[ACT TourRunner] Preconditions for step:",S,y.preconditions),y.preconditions?.length>0){console.log("[ACT TourRunner] Applying",y.preconditions.length,"preconditions");const t=await D(y.preconditions);if(console.log("[ACT TourRunner] Precondition result:",t),!e)return;t.success||console.warn("Some preconditions failed:",t.failedPreconditions)}else console.log("[ACT TourRunner] No preconditions for this step");if(i(!1),y.target){const o=y.recovery?async()=>{await D(y.recovery)}:null,i=await async function(e,t=null){let n=C(e);if(n.success)return n;if(t)try{if(await t(),await new Promise(e=>setTimeout(e,100)),n=C(e),n.success)return{...n,recovered:!0}}catch(e){return{success:!1,error:`Recovery failed: ${e.message}`}}return n}(y.target,o);if(!e)return;if(i.success){n=i.element,t(i.element),c({success:!0,usedLocator:i.usedLocator,recovered:i.recovered||!1});let e=i.element.getAttribute("data-block");if(!e){const t=i.element.closest("[data-block]");t&&(e=t.getAttribute("data-block"),console.log("[ACT TourRunner] Found parent block:",e))}if(e)try{const t=(0,a.dispatch)("core/block-editor");t?.selectBlock&&(await t.selectBlock(e),console.log("[ACT TourRunner] Selected block:",e))}catch(e){console.warn("[ACT TourRunner] Could not select block:",e)}(s=i.element)&&(s.ownerDocument!==document?(s.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),setTimeout(()=>{const e=document.querySelector('iframe[name="editor-canvas"]');if(e){const t=s.getBoundingClientRect(),n=e.getBoundingClientRect(),r=n.top+t.top,o=n.top+t.bottom,c=window.innerHeight;if(!(r>=100&&o<=c-100)){const e=r+window.scrollY-c/2;window.scrollTo({top:Math.max(0,e),behavior:"smooth"})}}},150)):s.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})),setTimeout(()=>{p.current&&i.element?.isConnected&&p.current.highlight(i.element)},350)}else n=null,t(null),r(i.error),c({success:!1,error:i.error}),console.log("[ACT TourRunner] Target resolution failed, NOT auto-advancing. Error:",i.error),p.current&&p.current.clear()}var s;if(y.completion&&n){if(console.log("[ACT TourRunner] Setting up completion watcher for step:",S,"type:",y.completion.type,"params:",y.completion.params),await new Promise(e=>setTimeout(e,100)),!e)return;const t=function(e,t=null){if(!e||!e.type)return F();const{type:n,params:r={}}=e,o=e.timeout||0;switch(n){case"clickTarget":return t?{promise:j(t,{timeout:o}),cancel:()=>{}}:{promise:Promise.resolve({success:!1,error:"No target element for clickTarget"}),cancel:()=>{}};case"domValueChanged":return t?{promise:q(t,{timeout:o,...r}),cancel:()=>{}}:{promise:Promise.resolve({success:!1,error:"No target element for domValueChanged"}),cancel:()=>{}};case"wpData":return{promise:M({timeout:o,...r}),cancel:()=>{}};case"manual":default:return F({timeout:o});case"elementAppear":return{promise:V(r.selector,{timeout:o}),cancel:()=>{}};case"elementDisappear":return{promise:G(r.selector,{timeout:o}),cancel:()=>{}};case"customEvent":return{promise:H(r.eventName,{timeout:o}),cancel:()=>{}}}}(y.completion,n);g.current=t,t.promise.then(async t=>{if(e&&t.success)if(console.log("[ACT TourRunner] Completion detected for step:",S),S<b-1){const t=_?.steps||[],n=await $(t,S,5e3);n.waited&&console.log("[ACT TourRunner] Waited for block:",n.blockType,"success:",n.success),setTimeout(()=>{e&&(console.log("[ACT TourRunner] Auto-advancing from step:",S),k())},300)}else console.log("[ACT TourRunner] Last step completed, ending tour"),O(),k()})}})(),()=>{e=!1,g.current?.cancel&&(console.log("[ACT TourRunner] Cleanup: Cancelling completion watcher"),g.current.cancel(),g.current=null)}},[f,y,S,u]);const R=(0,l.useCallback)(async()=>{if(g.current?.confirm)g.current.confirm();else{if(S<b-1){const e=_?.steps||[],t=await $(e,S,5e3);t.waited&&console.log("[ACT TourRunner] Manual continue waited for block:",t.blockType)}k()}},[k,S,b,_]),v=(0,l.useCallback)(()=>{g.current?.cancel&&(g.current.cancel(),g.current=null),d(e=>e+1),w()},[w]),P=(0,l.useCallback)(()=>{g.current?.cancel&&(g.current.cancel(),g.current=null),O(),h.current=null,A()},[A]);if(!f||!_||!y)return null;const N=(0,m.jsx)(T,{step:y,stepIndex:S,totalSteps:b,tourTitle:_.title,targetElement:e,resolutionError:n,isApplyingPreconditions:s,onContinue:R,onRepeat:v,onPrevious:I,onNext:k,onStop:P});return(0,l.createPortal)(N,document.body)}const X=window.wp.apiFetch;var Y=o.n(X);const Q="admin-coach-tours",J={media:"ðŸ–¼ï¸",content:"ðŸ“",layout:"ðŸ“",formatting:"âœ¨",default:"ðŸ“š"};function Z(){const[e,t]=(0,l.useState)(!1),[n,r]=(0,l.useState)([]),[o,c]=(0,l.useState)(!1),[s,i]=(0,l.useState)(null),[p,h]=(0,l.useState)(""),[g,T]=(0,l.useState)("tasks"),[f,E]=(0,l.useState)(!1),_=(0,l.useRef)(null),{storeLoading:y,aiTourError:S,isPlaying:b,aiAvailable:A}=(0,a.useSelect)(e=>{const t=e(Q);return{storeLoading:t.isAiTourLoading?.()??!1,aiTourError:t.getAiTourError?.()??null,isPlaying:null!==t.getCurrentTour(),aiAvailable:window.adminCoachTours?.aiAvailable??!1}},[]),k=f||y;(0,l.useEffect)(()=>{b&&f&&E(!1)},[b,f]);const{requestAiTour:C,clearEphemeralTour:I}=(0,a.useDispatch)(Q);(0,l.useEffect)(()=>{e&&0===n.length&&!o&&(c(!0),i(null),Y()({path:"/admin-coach-tours/v1/ai/tasks"}).then(e=>{e.available&&e.tasks?r(e.tasks):i((0,u.__)("AI is not available.","admin-coach-tours"))}).catch(e=>{i(e.message||(0,u.__)("Failed to load tasks.","admin-coach-tours"))}).finally(()=>{c(!1)}))},[e,n.length,o]),(0,l.useEffect)(()=>{"chat"===g&&_.current&&_.current.focus()},[g]);const w=(0,l.useCallback)(e=>{E(!0),t(!1);const n=window.adminCoachTours?.postType||"post";C(e,"",n)},[C]),R=(0,l.useCallback)(e=>{if(e.preventDefault(),!p.trim())return;E(!0),t(!1);const n=window.adminCoachTours?.postType||"post";C("",p.trim(),n),h("")},[p,C]),v=(0,l.useCallback)(()=>{t(e=>!e)},[]),x=(0,l.useCallback)(()=>{t(!1)},[]);if(!A)return(0,m.jsxs)("div",{className:"act-pupil-launcher",children:[(0,m.jsx)("button",{className:"act-pupil-launcher__fab",onClick:v,"aria-expanded":e,"aria-label":(0,u.__)("Open AI Coach","admin-coach-tours"),children:(0,m.jsx)("span",{className:"act-pupil-launcher__icon",children:"ðŸ’¡"})}),e&&(0,m.jsxs)("div",{className:"act-pupil-launcher__panel",children:[(0,m.jsxs)("div",{className:"act-pupil-launcher__header",children:[(0,m.jsx)("h3",{children:(0,u.__)("AI Coach","admin-coach-tours")}),(0,m.jsx)("button",{className:"act-pupil-launcher__close",onClick:x,"aria-label":(0,u.__)("Close","admin-coach-tours"),children:"Ã—"})]}),(0,m.jsx)("div",{className:"act-pupil-launcher__content",children:(0,m.jsxs)("div",{className:"act-pupil-launcher__not-configured",children:[(0,m.jsx)("p",{children:(0,u.__)("AI is not configured yet.","admin-coach-tours")}),(0,m.jsxs)("p",{children:[(0,u.__)("Go to ","admin-coach-tours"),(0,m.jsx)("a",{href:"/wp-admin/tools.php?page=admin-coach-tours",children:(0,u.__)("Tools â†’ Coach Tours","admin-coach-tours")}),(0,u.__)(" to add your API key.","admin-coach-tours")]})]})})]})]});const O=n.reduce((e,t)=>{const n=t.category||"other";return e[n]||(e[n]=[]),e[n].push(t),e},{}),P=k&&(0,l.createPortal)((0,m.jsx)("div",{className:"act-ai-loading-overlay",children:(0,m.jsxs)("div",{className:"act-ai-loading-overlay__content",children:[(0,m.jsx)("div",{className:"act-ai-loading-overlay__spinner"}),(0,m.jsx)("h2",{className:"act-ai-loading-overlay__title",children:(0,u.__)("Creating your guided tour...","admin-coach-tours")}),(0,m.jsx)("p",{className:"act-ai-loading-overlay__text",children:(0,u.__)("AI is analyzing the editor and generating step-by-step instructions.","admin-coach-tours")}),(0,m.jsx)("p",{className:"act-ai-loading-overlay__hint",children:(0,u.__)("This usually takes a few seconds.","admin-coach-tours")})]})}),document.body);return b?P||null:(0,m.jsxs)(m.Fragment,{children:[P,(0,m.jsxs)("div",{className:"act-pupil-launcher",children:[(0,m.jsx)("button",{className:"act-pupil-launcher__fab",onClick:v,"aria-expanded":e,"aria-label":(0,u.__)("Open AI Coach","admin-coach-tours"),disabled:k,children:k?(0,m.jsx)("span",{className:"act-pupil-launcher__spinner"}):(0,m.jsx)("span",{className:"act-pupil-launcher__icon",children:"ðŸ’¡"})}),e&&(0,m.jsxs)("div",{className:"act-pupil-launcher__panel",children:[k&&(0,m.jsxs)("div",{className:"act-pupil-launcher__ai-loading",children:[(0,m.jsx)("div",{className:"act-pupil-launcher__ai-loading-spinner"}),(0,m.jsx)("span",{className:"act-pupil-launcher__ai-loading-text",children:(0,u.__)("Creating your tour...","admin-coach-tours")}),(0,m.jsx)("span",{className:"act-pupil-launcher__ai-loading-hint",children:(0,u.__)("AI is generating step-by-step instructions","admin-coach-tours")})]}),(0,m.jsxs)("div",{className:"act-pupil-launcher__header",children:[(0,m.jsx)("h3",{children:(0,u.__)("What would you like to learn?","admin-coach-tours")}),(0,m.jsx)("button",{className:"act-pupil-launcher__close",onClick:x,"aria-label":(0,u.__)("Close","admin-coach-tours"),children:"Ã—"})]}),(0,m.jsxs)("div",{className:"act-pupil-launcher__tabs",children:[(0,m.jsx)("button",{className:"act-pupil-launcher__tab "+("tasks"===g?"is-active":""),onClick:()=>T("tasks"),children:(0,u.__)("Common Tasks","admin-coach-tours")}),(0,m.jsx)("button",{className:"act-pupil-launcher__tab "+("chat"===g?"is-active":""),onClick:()=>T("chat"),children:(0,u.__)("Ask a Question","admin-coach-tours")})]}),(0,m.jsxs)("div",{className:"act-pupil-launcher__content",children:[(S||s)&&(0,m.jsx)("div",{className:"act-pupil-launcher__error",children:S||s}),"tasks"===g&&(0,m.jsxs)("div",{className:"act-pupil-launcher__tasks",children:[o&&(0,m.jsx)("div",{className:"act-pupil-launcher__loading",children:(0,u.__)("Loading tasks...","admin-coach-tours")}),!o&&Object.entries(O).map(([e,t])=>(0,m.jsxs)("div",{className:"act-pupil-launcher__category",children:[(0,m.jsxs)("h4",{children:[(0,m.jsx)("span",{className:"act-pupil-launcher__category-icon",children:J[e]||J.default}),e.charAt(0).toUpperCase()+e.slice(1)]}),(0,m.jsx)("div",{className:"act-pupil-launcher__task-list",children:t.map(e=>(0,m.jsxs)("button",{className:"act-pupil-launcher__task",onClick:()=>w(e.id),disabled:k,children:[(0,m.jsx)("span",{className:"act-pupil-launcher__task-icon",children:e.icon?(0,m.jsx)(d.Dashicon,{icon:e.icon}):"ðŸ“Œ"}),(0,m.jsx)("span",{className:"act-pupil-launcher__task-label",children:e.label})]},e.id))})]},e))]}),"chat"===g&&(0,m.jsxs)("div",{className:"act-pupil-launcher__chat",children:[(0,m.jsx)("p",{className:"act-pupil-launcher__chat-hint",children:(0,u.__)("Ask about the WordPress editor:","admin-coach-tours")}),(0,m.jsxs)("form",{onSubmit:R,children:[(0,m.jsx)("input",{ref:_,type:"text",className:"act-pupil-launcher__chat-input",value:p,onChange:e=>h(e.target.value),placeholder:(0,u.__)("e.g., How do I add a gallery?","admin-coach-tours"),disabled:k}),(0,m.jsx)("button",{type:"submit",className:"act-pupil-launcher__chat-submit",disabled:k||!p.trim(),children:k?(0,u.__)("Generating...","admin-coach-tours"):(0,u.__)("Get Tour","admin-coach-tours")})]}),(0,m.jsx)("p",{className:"act-pupil-launcher__chat-note",children:(0,u.__)("AI will create a step-by-step tour to guide you.","admin-coach-tours")})]})]})]})]})]})}const ee={tours:{},toursLoading:!1,toursError:null,currentTourId:null,currentStepIndex:0,mode:null,completionSatisfied:!1,skippedSteps:[],isPickerActive:!1,pickingStepId:null,selectedStepId:null,pendingChanges:!1,tourProgress:{},isRecovering:!1,lastError:null,resolvedTarget:null,resolutionAttempts:0,sidebarOpen:!1,aiDraftLoading:!1,aiDraftError:null,aiDraftResult:null,aiTourLoading:!1,aiTourError:null,ephemeralTour:null},te={SET_TOURS_LOADING:"SET_TOURS_LOADING",SET_TOURS_ERROR:"SET_TOURS_ERROR",RECEIVE_TOURS:"RECEIVE_TOURS",RECEIVE_TOUR:"RECEIVE_TOUR",SET_CURRENT_TOUR:"SET_CURRENT_TOUR",START_TOUR:"START_TOUR",END_TOUR:"END_TOUR",SET_CURRENT_STEP:"SET_CURRENT_STEP",NEXT_STEP:"NEXT_STEP",PREVIOUS_STEP:"PREVIOUS_STEP",SKIP_STEP:"SKIP_STEP",REPEAT_STEP:"REPEAT_STEP",SET_MODE:"SET_MODE",SET_COMPLETION_SATISFIED:"SET_COMPLETION_SATISFIED",RESET_COMPLETION:"RESET_COMPLETION",SET_RESOLVED_TARGET:"SET_RESOLVED_TARGET",CLEAR_RESOLVED_TARGET:"CLEAR_RESOLVED_TARGET",SET_RECOVERING:"SET_RECOVERING",INCREMENT_RESOLUTION_ATTEMPTS:"INCREMENT_RESOLUTION_ATTEMPTS",SET_LAST_ERROR:"SET_LAST_ERROR",ACTIVATE_PICKER:"ACTIVATE_PICKER",DEACTIVATE_PICKER:"DEACTIVATE_PICKER",SELECT_STEP:"SELECT_STEP",SET_PENDING_CHANGES:"SET_PENDING_CHANGES",UPDATE_STEP:"UPDATE_STEP",ADD_STEP:"ADD_STEP",DELETE_STEP:"DELETE_STEP",REORDER_STEPS:"REORDER_STEPS",SET_AI_DRAFT_LOADING:"SET_AI_DRAFT_LOADING",SET_AI_DRAFT_ERROR:"SET_AI_DRAFT_ERROR",SET_AI_DRAFT_RESULT:"SET_AI_DRAFT_RESULT",CLEAR_AI_DRAFT:"CLEAR_AI_DRAFT",SET_SIDEBAR_OPEN:"SET_SIDEBAR_OPEN",SET_AI_TOUR_LOADING:"SET_AI_TOUR_LOADING",RECEIVE_EPHEMERAL_TOUR:"RECEIVE_EPHEMERAL_TOUR",SET_AI_TOUR_ERROR:"SET_AI_TOUR_ERROR",CLEAR_EPHEMERAL_TOUR:"CLEAR_EPHEMERAL_TOUR"},ne=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)});function re(e){return{type:te.SET_TOURS_LOADING,isLoading:e}}function oe(e){return{type:te.SET_TOURS_ERROR,error:e}}function ce(e){return{type:te.RECEIVE_TOURS,tours:e}}function se(e){return{type:te.RECEIVE_TOUR,tour:e}}function*ie(e){if(e){try{const t=yield{type:"API_FETCH",request:{path:`/admin-coach-tours/v1/tours/${e}`,method:"GET"}};t&&t.id&&(yield se(t))}catch(t){console.log("[ACT] Tour not found, creating placeholder for:",e),yield se({id:e,title:"",steps:[],status:"draft"})}yield{type:te.SET_CURRENT_TOUR,tourId:e}}else yield{type:te.SET_CURRENT_TOUR,tourId:null}}function le(e={}){return{type:"FETCH_TOURS",args:e}}function ae(e){return{type:"FETCH_TOUR",tourId:e}}function*ue(e,t){try{const n=yield{type:"SAVE_TOUR",tourId:e,tourData:t};return n?.id&&(yield se(n)),n}catch(e){throw e}}function*de(e){try{const t=yield{type:"CREATE_TOUR",data:e};return t?.id&&(yield se(t)),t}catch(e){throw e}}function*pe(e,t){try{const n=yield{type:"UPDATE_TOUR",tourId:e,data:t};return n?.id&&(yield se(n)),n}catch(e){throw e}}function me(e,t="pupil"){return{type:te.START_TOUR,tourId:e,mode:t}}function he(){return{type:te.END_TOUR}}function ge(){return he()}function Te(e){return{type:te.SET_CURRENT_STEP,stepIndex:e}}function fe(){return{type:te.NEXT_STEP}}function Ee(){return{type:te.PREVIOUS_STEP}}function _e(){return{type:te.SKIP_STEP}}function ye(){return{type:te.REPEAT_STEP}}function Se(e){return{type:te.SET_MODE,mode:e}}function be(e){return{type:te.SET_COMPLETION_SATISFIED,satisfied:e}}function Ae(){return{type:te.RESET_COMPLETION}}function ke(){return fe()}function Ce(e){return{type:te.SET_RESOLVED_TARGET,target:e}}function Ie(){return{type:te.CLEAR_RESOLVED_TARGET}}function we(e){return{type:te.SET_RECOVERING,isRecovering:e}}function Re(){return{type:te.INCREMENT_RESOLUTION_ATTEMPTS}}function ve(e){return{type:te.SET_LAST_ERROR,error:e}}function xe(e=null){return{type:te.ACTIVATE_PICKER,stepId:e}}function Oe(e=null){return xe(e)}function Pe(){return{type:te.DEACTIVATE_PICKER}}function Ne(){return Pe()}function Be(e){return{type:te.SELECT_STEP,stepId:e}}function Le(e){return{type:te.SET_PENDING_CHANGES,pending:e}}function*De(e,t,n){yield{type:te.UPDATE_STEP,tourId:e,stepId:t,updates:n}}function*Ue(e,t={},n=null){const r={id:ne(),order:0,title:"",instruction:"",hint:"",target:{locators:[],constraints:{visible:!0}},preconditions:[],completion:{type:"manual"},recovery:[{action:"reapplyPreconditions",timeout:1e3}],tags:[],version:1,...t};yield{type:te.ADD_STEP,tourId:e,step:r,index:n}}function*je(e,t){yield{type:te.DELETE_STEP,tourId:e,stepId:t}}function*qe(e,t){yield{type:te.REORDER_STEPS,tourId:e,stepIds:t}}function Me(e){return{type:te.SET_AI_DRAFT_LOADING,isLoading:e}}function Fe(e){return{type:te.SET_AI_DRAFT_ERROR,error:e}}function Ve(e){return{type:te.SET_AI_DRAFT_RESULT,result:e}}function Ge(){return{type:te.CLEAR_AI_DRAFT}}function*He(e,t){yield Me(!0),yield Fe(null);try{const n=yield{type:"REQUEST_AI_DRAFT",elementContext:e,postType:t};return yield Ve(n),n}catch(e){throw yield Fe(e.message||"Failed to generate AI draft"),e}finally{yield Me(!1)}}function We(e){return{type:te.SET_SIDEBAR_OPEN,isOpen:e}}function $e(e){return{type:te.SET_AI_TOUR_LOADING,isLoading:e}}function ze(e){return{type:te.SET_AI_TOUR_ERROR,error:e}}function Ke(e){return{type:te.RECEIVE_EPHEMERAL_TOUR,tour:e}}function Xe(){return{type:te.CLEAR_EPHEMERAL_TOUR}}function*Ye(e,t,n){yield $e(!0),yield ze(null);try{const r=yield{type:"GATHER_EDITOR_CONTEXT"},o=yield{type:"REQUEST_AI_TOUR",taskId:e,query:t,postType:n,editorContext:r};console.log("[ACT AI Response] Full result:",o),console.log("[ACT AI Response] Tour:",JSON.stringify(o.tour,null,2));const c={id:"ephemeral",...o.tour};return yield Ke(c),yield{type:"ENSURE_EMPTY_PLACEHOLDER"},yield me("ephemeral","pupil"),c}catch(e){throw yield ze(e.message||"Failed to generate tour"),e}finally{yield $e(!1)}}function*Qe(e){const t={id:"ephemeral",...e};yield Ke(t),yield{type:"ENSURE_EMPTY_PLACEHOLDER"},yield me("ephemeral","pupil")}function Je(e){return e.tours}const Ze=(0,a.createSelector)(e=>Object.values(e.tours),e=>[e.tours]);function et(e,t){return e.tours[t]||null}function tt(e){return e.toursLoading}function nt(e){return e.toursError}const rt=(0,a.createSelector)((e,t)=>Ze(e).filter(e=>e.postTypes&&e.postTypes.includes(t)&&"publish"===e.status),(e,t)=>[e.tours,t]),ot=(0,a.createSelector)((e,t)=>Ze(e).filter(e=>e.editor===t&&"publish"===e.status),(e,t)=>[e.tours,t]);function ct(e){return e.currentTourId}function st(e){return e.currentTourId?e.tours[e.currentTourId]:null}function it(e){return e.currentStepIndex}const lt=(0,a.createSelector)(e=>{const t=st(e);return t&&t.steps&&t.steps[e.currentStepIndex]||null},e=>[e.tours,e.currentTourId,e.currentStepIndex]);function at(e){const t=st(e);return t?.steps?.length||0}function ut(e){return e.currentStepIndex<at(e)-1}function dt(e){return e.currentStepIndex>0}function pt(e){const t=at(e);return 0===t?0:Math.round((e.currentStepIndex+1)/t*100)}function mt(e){return e.mode}function ht(e){return"educator"===e.mode}function gt(e){return"pupil"===e.mode}function Tt(e){return null!==e.currentTourId&&null!==e.mode}function ft(e){return e.completionSatisfied}function Et(e){return e.skippedSteps}function _t(e,t){return e.skippedSteps.includes(t)}function yt(e){return e.resolvedTarget}function St(e){return e.isRecovering}function bt(e){return e.resolutionAttempts}function At(e){return e.lastError}function kt(e){return e.isPickerActive}function Ct(e){return e.pickingStepId||null}function It(e){return e.selectedStepId}const wt=(0,a.createSelector)(e=>{const t=st(e);return t&&e.selectedStepId?t.steps.find(t=>t.id===e.selectedStepId):null},e=>[e.tours,e.currentTourId,e.selectedStepId]);function Rt(e){return e.pendingChanges}function vt(e){return e.aiDraftLoading}function xt(e){return vt(e)}function Ot(e){return e.aiDraftError}function Pt(e){return e.aiDraftResult}function Nt(e){return Pt(e)}function Bt(e){return e.sidebarOpen}function Lt(e){return e.aiTourLoading}function Dt(e){return e.aiTourError}function Ut(e){return e.ephemeralTour}function jt(e){return"ephemeral"===e.currentTourId&&"pupil"===e.mode}function*qt(){yield re(!0);try{const e=yield{type:"API_FETCH",request:{path:"/admin-coach-tours/v1/tours",method:"GET"}};yield ce(e)}catch(e){yield oe(e.message||"Failed to fetch tours")}}function*Mt(e){yield re(!0);try{const t=yield{type:"API_FETCH",request:{path:`/admin-coach-tours/v1/tours/${e}`,method:"GET"}};yield se(t)}catch(e){yield oe(e.message||"Failed to fetch tour")}}function*Ft(e){yield re(!0);try{const t=yield{type:"API_FETCH",request:{path:`/admin-coach-tours/v1/tours?post_type=${e}&editor=block`,method:"GET"}};yield ce(t)}catch(e){yield oe(e.message||"Failed to fetch tours")}}function Vt(){const e={inserterOpen:!1,sidebarOpen:!1,sidebarTab:null,toolbarVisible:!1,hasSelectedBlock:!1,selectedBlockType:null};try{const t=(0,a.select)("core/editor");t?.isInserterOpened&&(e.inserterOpen=t.isInserterOpened());const n=(0,a.select)("core/edit-post");if(n?.getActiveGeneralSidebarName){const t=n.getActiveGeneralSidebarName();e.sidebarOpen=!!t,e.sidebarTab=t||null}const r=(0,a.select)("core/block-editor");if(r?.getSelectedBlock){const t=r.getSelectedBlock();e.hasSelectedBlock=!!t,e.selectedBlockType=t?.name||null}e.toolbarVisible=!!document.querySelector(".block-editor-block-toolbar")}catch(e){console.warn("[ACT] Error getting visible elements:",e)}return e}function Gt(){try{const e=(0,a.select)("core/block-editor");if(!e?.getBlocks)return[];const t=e.getBlocks(),n=e.getSelectedBlockClientId?.()||null,r=document.querySelector('iframe[name="editor-canvas"]'),o=r?.contentDocument||null;return t.map((e,t)=>{const r={name:e.name,clientId:e.clientId,isEmpty:Ht(e),isSelected:e.clientId===n,order:t};if(o){const t=o.querySelector(`[data-block="${e.clientId}"]`);t&&(r.domInfo={tagName:t.tagName.toLowerCase(),dataType:t.getAttribute("data-type"),dataBlock:e.clientId,hasRichText:!!t.querySelector(".block-editor-rich-text__editable"),editableSelector:t.querySelector(".block-editor-rich-text__editable")?`[data-block="${e.clientId}"] .block-editor-rich-text__editable`:null})}return r})}catch(e){return console.warn("[ACT] Error getting editor blocks:",e),[]}}function Ht(e){return!(e&&("core/paragraph"===e.name?e.attributes?.content&&""!==e.attributes.content:"core/image"===e.name?e.attributes?.url:"core/video"!==e.name||e.attributes?.src))}function Wt(){const e={inserterButton:null,publishButton:null,settingsButton:null,searchInput:null,emptyBlockPlaceholder:null};try{const t=[".editor-document-tools__inserter-toggle","button.block-editor-inserter-toggle",'[aria-label="Toggle block inserter"]'];for(const n of t){const t=document.querySelector(n);if(t){e.inserterButton={selector:n,ariaLabel:t.getAttribute("aria-label")||null,visible:$t(t)};break}}const n=[".editor-post-publish-button",".editor-post-save-draft"];for(const t of n){const n=document.querySelector(t);if(n){e.publishButton={selector:t,text:n.textContent?.trim()||null,visible:$t(n)};break}}const r=document.querySelector('button[aria-label="Settings"]');r&&(e.settingsButton={selector:'button[aria-label="Settings"]',visible:$t(r)});const o=document.querySelector(".components-search-control__input");o&&(e.searchInput={selector:".components-search-control__input",visible:$t(o)});const c=[{selector:".block-editor-default-block-appender__content",inIframe:!0},{selector:'[data-empty="true"] .block-editor-rich-text__editable',inIframe:!0},{selector:'p[data-empty="true"]',inIframe:!0},{selector:".block-editor-default-block-appender__content",inIframe:!1}];for(const{selector:t,inIframe:n}of c){let r=null;if(n){const e=document.querySelector('iframe[name="editor-canvas"]');e?.contentDocument&&(r=e.contentDocument.querySelector(t))}else r=document.querySelector(t);if(r){e.emptyBlockPlaceholder={selector:t,inIframe:n,placeholder:r.getAttribute("data-placeholder")||r.getAttribute("aria-label")||null,visible:!0};break}}}catch(e){console.warn("[ACT] Error sampling UI elements:",e)}return e}function $t(e){if(!e)return!1;const t=e.getBoundingClientRect(),n=window.getComputedStyle(e);return t.width>0&&t.height>0&&"hidden"!==n.visibility&&"none"!==n.display}function zt(e){if(null==e||""===e)return!0;if("string"==typeof e)return""===e.trim();if("object"==typeof e&&null!==e){if("number"==typeof e.length)return 0===e.length;if("function"==typeof e.toString){const t=e.toString();if("[object Object]"!==t)return""===t.trim()}if("function"==typeof e.toJSON){const t=e.toJSON();if("string"==typeof t)return""===t.trim()}}return!(!Array.isArray(e)||0!==e.length)}async function Kt(e){await new Promise(e=>setTimeout(e,100));const t=document.querySelector('iframe[name="editor-canvas"]'),n=t?.contentDocument||document,r=n.querySelector(`[data-block="${e}"]`);if(!r)return console.warn("[ACT focusBlock] Block element not found:",e),!1;const o=['[contenteditable="true"]',".block-editor-rich-text__editable","textarea",'input[type="text"]'];let c=null;for(const e of o)if(c=r.querySelector(e),c)break;if(c||(c=r),c.scrollIntoView({behavior:"smooth",block:"center"}),c.focus(),"true"===c.getAttribute("contenteditable")){const e=n.getSelection(),t=n.createRange();t.selectNodeContents(c),t.collapse(!1),e?.removeAllRanges(),e?.addRange(t)}return console.log("[ACT focusBlock] Focused:",c.tagName,c.className),!0}const Xt={API_FETCH:e=>Y()(e.request),GATHER_EDITOR_CONTEXT:()=>({editorBlocks:Gt(),visibleElements:Vt(),uiSamples:Wt(),wpVersion:window.adminCoachTours?.wpVersion||"unknown",timestamp:Date.now()}),ENSURE_EMPTY_PLACEHOLDER:()=>async function(){if(function(){try{const e=(0,a.select)("core/block-editor");return!!e?.getBlocks&&!!e.getBlocks().find(e=>"core/paragraph"===e.name&&zt(e.attributes?.content))}catch(e){return console.warn("[ACT] Error checking for empty paragraph:",e),!1}}()){const e=(0,a.select)("core/block-editor"),t=(e?.getBlocks()||[]).find(e=>"core/paragraph"===e.name&&zt(e.attributes?.content));return t&&(await(0,a.dispatch)("core/block-editor").selectBlock(t.clientId),console.log("[ACT] Selected existing empty paragraph:",t.clientId),await Kt(t.clientId)),{wasInserted:!1,clientId:t?.clientId||null}}console.log("[ACT] No empty paragraph found, inserting one");const e=await async function(){try{const{createBlock:e}=await Promise.resolve().then(o.t.bind(o,997,23)),t=(0,a.dispatch)("core/block-editor");if(!t||!e)return console.warn("[ACT] Block editor not available for inserting paragraph"),null;const n=e("core/paragraph",{content:""}),r=(0,a.select)("core/block-editor"),c=(r?.getBlocks()||[]).length;return await t.insertBlock(n,c,"",!1),await t.selectBlock(n.clientId),console.log("[ACT] Inserted and selected empty paragraph block:",n.clientId),n.clientId}catch(e){return console.error("[ACT] Error inserting empty paragraph:",e),null}}();return e?(await async function(e,t=3e3,n=50){const r=Date.now();for(;Date.now()-r<t;){if(e())return!0;await new Promise(e=>setTimeout(e,n))}return!1}(()=>{const t=document.querySelector('iframe[name="editor-canvas"]'),n=t?.contentDocument;return!!(n||document).querySelector(`[data-block="${e}"]`)},3e3)?(console.log("[ACT] Block appeared in DOM:",e),await Kt(e)):console.warn("[ACT] Block inserted but not found in DOM:",e),{wasInserted:!0,clientId:e}):{wasInserted:!1,clientId:null}}(),FETCH_TOUR:e=>Y()({path:`/admin-coach-tours/v1/tours/${e.tourId}`,method:"GET"}),FETCH_TOURS(e){const t=new URLSearchParams;e.args.postType&&t.append("post_type",e.args.postType),e.args.editor&&t.append("editor",e.args.editor);const n=t.toString(),r="/admin-coach-tours/v1/tours"+(n?`?${n}`:"");return Y()({path:r,method:"GET"})},SAVE_TOUR:e=>(console.log("[ACT Controls] SAVE_TOUR:",e.tourId,e.tourData),console.log("[ACT Controls] Steps count:",e.tourData?.steps?.length),Y()({path:`/admin-coach-tours/v1/tours/${e.tourId}`,method:"PUT",data:e.tourData})),CREATE_TOUR:e=>Y()({path:"/admin-coach-tours/v1/tours",method:"POST",data:e.data}),UPDATE_TOUR:e=>Y()({path:`/admin-coach-tours/v1/tours/${e.tourId}`,method:"PUT",data:e.data}),REQUEST_AI_DRAFT:e=>Y()({path:"/admin-coach-tours/v1/ai/generate-draft",method:"POST",data:{elementContext:e.elementContext,postType:e.postType}}),REQUEST_AI_TOUR:e=>Y()({path:"/admin-coach-tours/v1/ai/generate-tour",method:"POST",data:{taskId:e.taskId,query:e.query,postType:e.postType,editorContext:e.editorContext||null}}),FETCH_AI_TASKS:()=>Y()({path:"/admin-coach-tours/v1/ai/tasks",method:"GET"})},Yt="admin-coach-tours",Qt=(0,a.createReduxStore)(Yt,{reducer:function(e=ee,t){switch(t.type){case te.SET_TOURS_LOADING:return{...e,toursLoading:t.isLoading};case te.SET_TOURS_ERROR:return{...e,toursError:t.error,toursLoading:!1};case te.RECEIVE_TOURS:return{...e,tours:t.tours.reduce((e,t)=>(e[t.id]=t,e),{...e.tours}),toursLoading:!1,toursError:null};case te.RECEIVE_TOUR:return{...e,tours:{...e.tours,[t.tour.id]:t.tour},toursLoading:!1};case te.SET_CURRENT_TOUR:return{...e,currentTourId:t.tourId,currentStepIndex:0,mode:t.tourId?"educator":null,selectedStepId:null};case te.START_TOUR:return{...e,currentTourId:t.tourId,currentStepIndex:0,mode:t.mode||"pupil",completionSatisfied:!1,skippedSteps:[],lastError:null,resolutionAttempts:0};case te.END_TOUR:return{...e,currentTourId:null,currentStepIndex:0,mode:null,completionSatisfied:!1,resolvedTarget:null,isRecovering:!1,lastError:null};case te.SET_CURRENT_STEP:return{...e,currentStepIndex:t.stepIndex,completionSatisfied:!1,resolvedTarget:null,resolutionAttempts:0,lastError:null};case te.NEXT_STEP:{const t=e.tours[e.currentTourId],n=e.currentStepIndex+1;return t&&n<t.steps.length?{...e,currentStepIndex:n,completionSatisfied:!1,resolvedTarget:null,resolutionAttempts:0,lastError:null}:{...e,currentTourId:null,currentStepIndex:0,mode:null,completionSatisfied:!1,resolvedTarget:null}}case te.PREVIOUS_STEP:return{...e,currentStepIndex:Math.max(0,e.currentStepIndex-1),completionSatisfied:!1,resolvedTarget:null,resolutionAttempts:0};case te.SKIP_STEP:{const t=e.tours[e.currentTourId],n=t?.steps[e.currentStepIndex],r=e.currentStepIndex+1,o=t&&r<t.steps.length,c=n?[...e.skippedSteps,n.id]:e.skippedSteps;return o?{...e,currentStepIndex:r,skippedSteps:c,completionSatisfied:!1,resolvedTarget:null,resolutionAttempts:0}:{...e,skippedSteps:c,currentTourId:null,currentStepIndex:0,mode:null}}case te.REPEAT_STEP:return{...e,completionSatisfied:!1,resolvedTarget:null,resolutionAttempts:0,lastError:null,isRecovering:!1};case te.SET_MODE:return{...e,mode:t.mode};case te.SET_COMPLETION_SATISFIED:return{...e,completionSatisfied:t.satisfied};case te.RESET_COMPLETION:return{...e,completionSatisfied:!1};case te.SET_RESOLVED_TARGET:return{...e,resolvedTarget:t.target,lastError:null};case te.CLEAR_RESOLVED_TARGET:return{...e,resolvedTarget:null};case te.SET_RECOVERING:return{...e,isRecovering:t.isRecovering};case te.INCREMENT_RESOLUTION_ATTEMPTS:return{...e,resolutionAttempts:e.resolutionAttempts+1};case te.SET_LAST_ERROR:return{...e,lastError:t.error};case te.ACTIVATE_PICKER:return{...e,isPickerActive:!0,pickingStepId:t.stepId||null};case te.DEACTIVATE_PICKER:return{...e,isPickerActive:!1,pickingStepId:null};case te.SELECT_STEP:return{...e,selectedStepId:t.stepId};case te.SET_PENDING_CHANGES:return{...e,pendingChanges:t.pending};case te.UPDATE_STEP:{const n=e.tours[t.tourId];if(!n)return e;const r=n.steps.map(e=>e.id===t.stepId?{...e,...t.updates}:e);return{...e,tours:{...e.tours,[t.tourId]:{...n,steps:r}},pendingChanges:!0}}case te.ADD_STEP:{var n;const r=e.tours[t.tourId];if(!r)return e;const o=[...r.steps],c=null!==(n=t.index)&&void 0!==n?n:o.length;return o.splice(c,0,t.step),o.forEach((e,t)=>{e.order=t}),{...e,tours:{...e.tours,[t.tourId]:{...r,steps:o}},selectedStepId:t.step.id,pendingChanges:!0}}case te.DELETE_STEP:{const n=e.tours[t.tourId];if(!n)return e;const r=n.steps.filter(e=>e.id!==t.stepId);return r.forEach((e,t)=>{e.order=t}),{...e,tours:{...e.tours,[t.tourId]:{...n,steps:r}},selectedStepId:e.selectedStepId===t.stepId?null:e.selectedStepId,pendingChanges:!0}}case te.REORDER_STEPS:{const n=e.tours[t.tourId];if(!n)return e;const r={};n.steps.forEach(e=>{r[e.id]=e});const o=t.stepIds.map((e,t)=>({...r[e],order:t}));return{...e,tours:{...e.tours,[t.tourId]:{...n,steps:o}},pendingChanges:!0}}case te.SET_AI_DRAFT_LOADING:return{...e,aiDraftLoading:t.isLoading,aiDraftError:t.isLoading?null:e.aiDraftError};case te.SET_AI_DRAFT_ERROR:return{...e,aiDraftError:t.error,aiDraftLoading:!1};case te.SET_AI_DRAFT_RESULT:return{...e,aiDraftResult:t.result,aiDraftLoading:!1,aiDraftError:null};case te.CLEAR_AI_DRAFT:return{...e,aiDraftResult:null,aiDraftError:null,aiDraftLoading:!1};case te.SET_SIDEBAR_OPEN:return{...e,sidebarOpen:t.isOpen};case te.SET_AI_TOUR_LOADING:return{...e,aiTourLoading:t.isLoading,aiTourError:t.isLoading?null:e.aiTourError};case te.SET_AI_TOUR_ERROR:return{...e,aiTourError:t.error,aiTourLoading:!1};case te.RECEIVE_EPHEMERAL_TOUR:return{...e,ephemeralTour:t.tour,aiTourLoading:!1,aiTourError:null,tours:{...e.tours,ephemeral:t.tour}};case te.CLEAR_EPHEMERAL_TOUR:return{...e,ephemeralTour:null,aiTourError:null,aiTourLoading:!1,tours:Object.fromEntries(Object.entries(e.tours).filter(([e])=>"ephemeral"!==e))};default:return e}},actions:c,selectors:s,resolvers:i,controls:Xt,initialState:ee});(0,a.select)(Yt)||(0,a.register)(Qt);const Jt="admin-coach-tours";function Zt(){console.log("[ACT Pupil] Initializing... v4"),console.log("[ACT Pupil] TourRunner:",typeof K,K),console.log("[ACT Pupil] AI Available:",window.adminCoachTours?.aiAvailable);const e=document.createElement("div");e.id="admin-coach-tours-pupil",document.body.appendChild(e);try{(0,l.render)((0,m.jsx)(K,{}),e),console.log("[ACT Pupil] TourRunner rendered successfully")}catch(e){console.error("[ACT Pupil] Error rendering TourRunner:",e)}const t=document.createElement("div");t.id="admin-coach-tours-launcher",document.body.appendChild(t);try{(0,l.render)((0,m.jsx)(Z,{}),t),console.log("[ACT Pupil] PupilLauncher rendered successfully")}catch(e){console.error("[ACT Pupil] Error rendering PupilLauncher:",e)}const n=window.top||window,r=new URLSearchParams(n.location.search).get("act_tour");if(console.log("[ACT Pupil] URL search:",n.location.search),console.log("[ACT Pupil] act_tour param:",r),r){const e=parseInt(r,10);console.log("[ACT Pupil] Will fetch and start tour:",e);const t=(0,a.select)(Jt).getTour(e);console.log("[ACT Pupil] Initial tour state:",t);const n=(0,a.subscribe)(()=>{const t=(0,a.select)(Jt),r=t.getTour(e),o=t.isToursLoading();r&&!o&&(console.log("[ACT Pupil] Tour loaded:",r),console.log("[ACT Pupil] Tour steps:",r.steps,"count:",r.steps?.length),n(),(0,a.dispatch)(Jt).startTour(e))});setTimeout(()=>{console.log("[ACT Pupil] Timeout reached, unsubscribing"),n()},1e4)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Zt):Zt()})();