(()=>{"use strict";var e,t,n={997(e){e.exports=window.wp.blocks}},r={};function o(e){var t=r[e];if(void 0!==t)return t.exports;var s=r[e]={exports:{}};return n[e](s,s.exports,o),s.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,o.t=function(n,r){if(1&r&&(n=this(n)),8&r)return n;if("object"==typeof n&&n){if(4&r&&n.__esModule)return n;if(16&r&&"function"==typeof n.then)return n}var s=Object.create(null);o.r(s);var i={};e=e||[null,t({}),t([]),t(t)];for(var c=2&r&&n;("object"==typeof c||"function"==typeof c)&&!~e.indexOf(c);c=t(c))Object.getOwnPropertyNames(c).forEach(e=>i[e]=()=>n[e]);return i.default=()=>n,o.d(s,i),s},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};o.r(s),o.d(s,{activatePicker:()=>Re,addStep:()=>De,clearAiDraft:()=>je,clearResolvedTarget:()=>Ae,createTour:()=>ce,deactivatePicker:()=>we,deleteStep:()=>Le,endTour:()=>ue,fetchTour:()=>se,fetchTours:()=>oe,incrementResolutionAttempts:()=>be,markStepComplete:()=>ye,nextStep:()=>me,previousStep:()=>Te,receiveTour:()=>ne,receiveTours:()=>te,reorderSteps:()=>Be,repeatStep:()=>fe,requestAiDraft:()=>Fe,resetCompletion:()=>Se,saveTour:()=>ie,selectStep:()=>ke,setAiDraftError:()=>Ue,setAiDraftLoading:()=>Ne,setAiDraftResult:()=>Me,setCompletionSatisfied:()=>he,setCurrentStep:()=>pe,setCurrentTour:()=>re,setLastError:()=>Ce,setMode:()=>Ee,setPendingChanges:()=>Pe,setRecovering:()=>Ie,setResolvedTarget:()=>_e,setSidebarOpen:()=>Ve,setToursError:()=>ee,setToursLoading:()=>J,skipStep:()=>ge,startPicking:()=>ve,startTour:()=>ae,stopPicking:()=>xe,stopTour:()=>de,updateStep:()=>Oe,updateTour:()=>le});var i={};o.r(i),o.d(i,{getAiDraft:()=>It,getAiDraftError:()=>_t,getAiDraftResult:()=>At,getCurrentStep:()=>Ye,getCurrentStepIndex:()=>Qe,getCurrentTour:()=>Ze,getCurrentTourId:()=>Xe,getLastError:()=>mt,getMode:()=>rt,getPickingStepId:()=>gt,getProgress:()=>nt,getResolutionAttempts:()=>pt,getResolvedTarget:()=>ut,getSelectedStep:()=>Et,getSelectedStepId:()=>ft,getSkippedSteps:()=>lt,getTotalSteps:()=>Je,getTour:()=>He,getTours:()=>Ge,getToursByEditor:()=>Ke,getToursById:()=>qe,getToursByPostType:()=>We,getToursError:()=>ze,hasNextStep:()=>et,hasPendingChanges:()=>ht,hasPreviousStep:()=>tt,isAiDraftLoading:()=>St,isAiDrafting:()=>yt,isCompletionSatisfied:()=>ct,isEducatorMode:()=>ot,isPickerActive:()=>Tt,isPupilMode:()=>st,isRecovering:()=>dt,isSidebarOpen:()=>bt,isTourActive:()=>it,isToursLoading:()=>$e,wasStepSkipped:()=>at});var c={};o.r(c),o.d(c,{getTour:()=>wt,getTours:()=>vt,getToursByPostType:()=>xt});const l=window.wp.element,a=window.wp.data,u=window.wp.i18n,d=window.wp.components,p=window.wp.primitives,m=window.ReactJSXRuntime,T=(0,m.jsx)(p.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,m.jsx)(p.Path,{d:"M20 11.2H6.8l3.7-3.7-1-1L3.9 12l5.6 5.5 1-1-3.7-3.7H20z"})}),g=(0,m.jsx)(p.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,m.jsx)(p.Path,{d:"M15.6 6.5l-1.1 1 2.9 3.3H8c-.9 0-1.7.3-2.3.9-1.4 1.5-1.4 4.2-1.4 5.6v.2h1.5v-.3c0-1.1 0-3.5 1-4.5.3-.3.7-.5 1.3-.5h9.2L14.5 15l1.1 1.1 4.6-4.6-4.6-5z"})}),f=(0,m.jsx)(p.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,m.jsx)(p.Path,{d:"M10.6 6L9.4 7l4.6 5-4.6 5 1.2 1 5.4-6z"})}),E=(0,m.jsx)(p.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,m.jsx)(p.Path,{d:"M12 4c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8Zm3.8 10.7-1.1 1.1-2.7-2.7-2.7 2.7-1.1-1.1 2.7-2.7-2.7-2.7 1.1-1.1 2.7 2.7 2.7-2.7 1.1 1.1-2.7 2.7 2.7 2.7Z"})}),h=(0,m.jsx)(p.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,m.jsx)(p.Path,{d:"m14.5 6.5-1 1 3.7 3.7H4v1.6h13.2l-3.7 3.7 1 1 5.6-5.5z"})}),S=(0,m.jsx)(p.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,m.jsx)(p.Path,{d:"m13.06 12 6.47-6.47-1.06-1.06L12 10.94 5.53 4.47 4.47 5.53 10.94 12l-6.47 6.47 1.06 1.06L12 13.06l6.47 6.47 1.06-1.06L13.06 12Z"})});function y({step:e,stepIndex:t,totalSteps:n,tourTitle:r,targetElement:o,resolutionError:s,isApplyingPreconditions:i,isPaused:c,onContinue:a,onRepeat:p,onPrevious:y,onNext:_,onPause:A,onResume:I,onStop:b}){const[C,R]=(0,l.useState)({x:20,y:20}),[v,w]=(0,l.useState)(!1),[x,k]=(0,l.useState)({x:0,y:0}),P=(0,l.useRef)(null),O=0===t,D=t===n-1,L="manual"===e?.completion?.type;(0,l.useEffect)(()=>{if(!o||v)return;const e=o.getBoundingClientRect(),t=320,n=200,r=20;let s,i;e.right+t+r<window.innerWidth?(s=e.right+r,i=e.top):e.left-t-r>0?(s=e.left-t-r,i=e.top):e.bottom+n+r<window.innerHeight?(s=Math.max(r,e.left),i=e.bottom+r):e.top-n-r>0?(s=Math.max(r,e.left),i=e.top-n-r):(s=window.innerWidth-t-r,i=window.innerHeight-n-r),s=Math.max(r,Math.min(s,window.innerWidth-t-r)),i=Math.max(r,Math.min(i,window.innerHeight-n-r)),R({x:s,y:i})},[o,v]);const B=(0,l.useCallback)(e=>{if(e.target.closest("button"))return;w(!0);const t=P.current.getBoundingClientRect();k({x:e.clientX-t.left,y:e.clientY-t.top})},[]),N=(0,l.useCallback)(e=>{if(!v)return;const t=e.clientX-x.x,n=e.clientY-x.y,r=P.current.getBoundingClientRect(),o=window.innerWidth-r.width,s=window.innerHeight-r.height;R({x:Math.max(0,Math.min(t,o)),y:Math.max(0,Math.min(n,s))})},[v,x]),U=(0,l.useCallback)(()=>{w(!1)},[]);return(0,l.useEffect)(()=>{if(v)return document.addEventListener("mousemove",N),document.addEventListener("mouseup",U),()=>{document.removeEventListener("mousemove",N),document.removeEventListener("mouseup",U)}},[v,N,U]),(0,m.jsxs)("div",{ref:P,className:"act-coach-panel",style:{position:"fixed",top:C.y,left:C.x,width:"320px",maxHeight:"400px",backgroundColor:"#fff",borderRadius:"8px",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.15)",zIndex:9999990,display:"flex",flexDirection:"column",cursor:v?"grabbing":"default"},onMouseDown:B,children:[(0,m.jsx)("div",{className:"act-panel-header",style:{padding:"12px 16px",borderBottom:"1px solid #e0e0e0",cursor:"grab",userSelect:"none"},children:(0,m.jsxs)(d.Flex,{justify:"space-between",align:"center",children:[(0,m.jsxs)(d.FlexBlock,{children:[(0,m.jsx)("strong",{className:"act-panel-title",children:e?.title||(0,u.__)("Step","admin-coach-tours")+` ${t+1}`}),(0,m.jsxs)("div",{className:"act-panel-progress",style:{fontSize:"12px",color:"#666"},children:[`${t+1} / ${n}`,r&&` • ${r}`]})]}),(0,m.jsx)(d.FlexItem,{children:(0,m.jsx)(d.Button,{icon:S,label:(0,u.__)("Close tour","admin-coach-tours"),onClick:b,size:"small"})})]})}),(0,m.jsx)("div",{className:"act-panel-body",style:{padding:"16px",flex:1,overflow:"auto"},children:i?(0,m.jsxs)("div",{className:"act-panel-loading",children:[(0,m.jsx)(d.Spinner,{}),(0,m.jsx)("span",{children:(0,u.__)("Preparing…","admin-coach-tours")})]}):s?(0,m.jsxs)("div",{className:"act-panel-error",children:[(0,m.jsx)("p",{children:(0,u.__)("Could not find the target element. The UI may have changed.","admin-coach-tours")}),(0,m.jsx)(d.Button,{variant:"secondary",onClick:p,children:(0,u.__)("Try Again","admin-coach-tours")})]}):(0,m.jsx)(m.Fragment,{children:e?.content&&(0,m.jsx)("div",{className:"act-panel-content",dangerouslySetInnerHTML:{__html:e.content}})})}),(0,m.jsx)("div",{className:"act-panel-footer",style:{padding:"12px 16px",borderTop:"1px solid #e0e0e0"},children:(0,m.jsx)("div",{className:"act-panel-controls",children:(0,m.jsxs)(d.Flex,{justify:"space-between",align:"center",children:[(0,m.jsx)(d.FlexItem,{children:(0,m.jsx)(d.Button,{icon:T,label:(0,u.__)("Previous","admin-coach-tours"),onClick:y,disabled:O||i,size:"small"})}),(0,m.jsxs)(d.FlexBlock,{style:{textAlign:"center"},children:[(0,m.jsx)(d.Button,{icon:g,label:(0,u.__)("Repeat","admin-coach-tours"),onClick:p,disabled:i,size:"small"}),c?(0,m.jsx)(d.Button,{icon:f,label:(0,u.__)("Resume","admin-coach-tours"),onClick:I,size:"small"}):(0,m.jsx)(d.Button,{icon:E,label:(0,u.__)("Pause","admin-coach-tours"),onClick:A,size:"small"})]}),(0,m.jsx)(d.FlexItem,{children:L||D?(0,m.jsx)(d.Button,{variant:"primary",onClick:a,disabled:i||!!s,size:"small",children:D?(0,u.__)("Finish","admin-coach-tours"):(0,u.__)("Continue","admin-coach-tours")}):(0,m.jsx)(d.Button,{icon:h,label:(0,u.__)("Next","admin-coach-tours"),onClick:_,disabled:i,size:"small"})})]})})})]})}const _={boxShadow:"0 0 0 4px #007cba, 0 0 0 9999px rgba(0, 0, 0, 0.5)",borderRadius:"4px",transition:"all 0.3s ease"};class A{constructor(e={}){this.options={usePulse:!0,overlayColor:"rgba(0, 0, 0, 0.5)",highlightColor:"#007cba",transitionDuration:300,...e},this.spotlightElement=null,this.targetElement=null,this.resizeObserver=null,this.styleElement=null,this._init()}_init(){this.styleElement=document.createElement("style"),this.styleElement.textContent="\n@keyframes act-pulse {\n\t0% {\n\t\tbox-shadow: 0 0 0 4px #007cba, 0 0 0 9999px rgba(0, 0, 0, 0.5);\n\t}\n\t50% {\n\t\tbox-shadow: 0 0 0 8px rgba(0, 124, 186, 0.5), 0 0 0 9999px rgba(0, 0, 0, 0.5);\n\t}\n\t100% {\n\t\tbox-shadow: 0 0 0 4px #007cba, 0 0 0 9999px rgba(0, 0, 0, 0.5);\n\t}\n}\n",document.head.appendChild(this.styleElement),this.spotlightElement=document.createElement("div"),this.spotlightElement.className="act-highlighter-spotlight",this.spotlightElement.setAttribute("aria-hidden","true"),Object.assign(this.spotlightElement.style,{position:"fixed",pointerEvents:"none",zIndex:9999980,..._}),this.spotlightElement.style.display="none",document.body.appendChild(this.spotlightElement),this.resizeObserver=new ResizeObserver(()=>{this._updatePosition()})}highlight(e){e&&e.isConnected?(this.targetElement&&this.resizeObserver.unobserve(this.targetElement),this.targetElement=e,this.resizeObserver.observe(e),this._updatePosition(),this.spotlightElement.style.display="block",this.options.usePulse&&(this.spotlightElement.style.animation="act-pulse 2s infinite"),this._addScrollListeners()):this.clear()}_updatePosition(){if(!this.targetElement||!this.spotlightElement)return;const e=this.targetElement.getBoundingClientRect();let t={top:0,left:0};const n=this.targetElement.ownerDocument;if(n!==document){const e=document.querySelectorAll("iframe");for(const r of e)if(r.contentDocument===n){const e=r.getBoundingClientRect();t={top:e.top,left:e.left};break}}Object.assign(this.spotlightElement.style,{top:e.top+t.top-4+"px",left:e.left+t.left-4+"px",width:`${e.width+8}px`,height:`${e.height+8}px`})}_addScrollListeners(){this._scrollHandler=()=>{this._updatePosition()};let e=this.targetElement?.parentElement;for(;e;)e.scrollHeight>e.clientHeight&&e.addEventListener("scroll",this._scrollHandler,{passive:!0}),e=e.parentElement;window.addEventListener("scroll",this._scrollHandler,{passive:!0}),window.addEventListener("resize",this._scrollHandler,{passive:!0})}_removeScrollListeners(){if(!this._scrollHandler)return;let e=this.targetElement?.parentElement;for(;e;)e.removeEventListener("scroll",this._scrollHandler),e=e.parentElement;window.removeEventListener("scroll",this._scrollHandler),window.removeEventListener("resize",this._scrollHandler),this._scrollHandler=null}clear(){this.targetElement&&(this.resizeObserver.unobserve(this.targetElement),this._removeScrollListeners(),this.targetElement=null),this.spotlightElement&&(this.spotlightElement.style.display="none",this.spotlightElement.style.animation="none")}async transitionTo(e){this.targetElement?(this.targetElement&&(this.resizeObserver.unobserve(this.targetElement),this._removeScrollListeners()),this.targetElement=e,e&&e.isConnected?(this.resizeObserver.observe(e),this._addScrollListeners(),await new Promise(e=>{requestAnimationFrame(()=>{this._updatePosition(),setTimeout(e,this.options.transitionDuration)})})):this.clear()):this.highlight(e)}setStyle(e){if(!this.spotlightElement)return;const t={default:"#007cba",success:"#00a32a",warning:"#dba617",error:"#d63638"},n=t[e]||t.default;this.spotlightElement.style.boxShadow=`0 0 0 4px ${n}, 0 0 0 9999px rgba(0, 0, 0, 0.5)`}async flash(){this.spotlightElement&&(this.setStyle("success"),await new Promise(e=>{setTimeout(()=>{this.setStyle("default"),e()},300)}))}destroy(){this.clear(),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.spotlightElement&&this.spotlightElement.parentNode&&(this.spotlightElement.parentNode.removeChild(this.spotlightElement),this.spotlightElement=null),this.styleElement&&this.styleElement.parentNode&&(this.styleElement.parentNode.removeChild(this.styleElement),this.styleElement=null)}}function I(e){if(!e)return!1;if(!e.isConnected)return!1;const t=window.getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility||"0"===t.opacity)return!1;const n=e.getBoundingClientRect();return 0!==n.width||0!==n.height}function b(e,t){if(!t)return!0;const n=(e.ownerDocument||document).querySelector(t);return!!n&&n.contains(e)}function C(e,t=document){try{return Array.from(t.querySelectorAll(e))}catch{return[]}}function R(e,t=document){switch(e.type){case"css":return C(e.value,t);case"role":return function(e,t=document){const[n,r]=e.split(":").map(e=>e.trim()),o=Array.from(t.querySelectorAll(`[role="${n}"]`)),s={button:'button, input[type="button"], input[type="submit"]',textbox:'input[type="text"], input:not([type]), textarea',link:"a[href]",checkbox:'input[type="checkbox"]',radio:'input[type="radio"]',listbox:"select",option:"option",heading:"h1, h2, h3, h4, h5, h6",img:"img[alt]",navigation:"nav",main:"main",complementary:"aside",banner:"header",contentinfo:"footer",search:'[role="search"]',form:"form",region:"section[aria-label], section[aria-labelledby]",tab:'[role="tab"]',tabpanel:'[role="tabpanel"]',tablist:'[role="tablist"]',menu:'[role="menu"]',menuitem:'[role="menuitem"]',dialog:'dialog, [role="dialog"]'};let i=[];s[n]&&(i=Array.from(t.querySelectorAll(s[n])));const c=[...o,...i];return r?c.filter(e=>{const t=function(e){if(e.getAttribute("aria-label"))return e.getAttribute("aria-label");const t=e.getAttribute("aria-labelledby");if(t){const e=document.getElementById(t);if(e)return e.textContent?.trim()||""}if(e.id){const t=document.querySelector(`label[for="${e.id}"]`);if(t)return t.textContent?.trim()||""}return e.getAttribute("title")?e.getAttribute("title"):"BUTTON"===e.tagName||"A"===e.tagName||"button"===e.getAttribute("role")?e.textContent?.trim()||"":"INPUT"===e.tagName&&e.value?e.value:""}(e);return t&&t.toLowerCase().includes(r.toLowerCase())}):c}(e.value,t);case"testid":case"testId":return function(e,t=document){return Array.from(t.querySelectorAll(`[data-testid="${e}"]`))}(e.value,t);case"dataattribute":case"dataAttribute":return function(e,t=document){const[n,r]=e.split(":").map(e=>e.trim()),o=r?`[data-${n}="${r}"]`:`[data-${n}]`;try{return Array.from(t.querySelectorAll(o))}catch{return[]}}(e.value,t);case"arialabel":case"ariaLabel":return function(e,t=document){return Array.from(t.querySelectorAll("[aria-label]")).filter(t=>{const n=t.getAttribute("aria-label");return n&&n.toLowerCase().includes(e.toLowerCase())})}(e.value,t);case"contextual":return function(e,t=document){const n=e.split(">>").map(e=>e.trim());if(2===n.length){const[e,r]=n,o=t.querySelector(e);return o?Array.from(o.querySelectorAll(r)):[]}return C(e)}(e.value,t);case"wpBlock":case"wpblock":return function(e,t=document){if("inserted"===e||e.startsWith("inserted:")){const n="inserted"===e?"act-inserted-block":e.substring(9),r=window.__actInsertedBlocks;if(console.log("[ACT findByWpBlock] Looking for inserted block, markerId:",n,"map exists:",!!r,"has key:",r?.has?.(n)),r?.has?.(n)){const e=r.get(n);console.log("[ACT findByWpBlock] Looking for inserted block:",n,"clientId:",e);let o=t.querySelector(`[data-block="${e}"]`);if(!o){const n=document.querySelector('iframe[name="editor-canvas"]'),r=n?.contentDocument;r&&r!==t&&(o=r.querySelector(`[data-block="${e}"]`),console.log("[ACT findByWpBlock] Searched iframe, found:",!!o))}if(o||t===document||(o=document.querySelector(`[data-block="${e}"]`),console.log("[ACT findByWpBlock] Searched main doc, found:",!!o)),o)return console.log("[ACT findByWpBlock] Found inserted block element"),[o]}return console.log("[ACT findByWpBlock] Inserted block not found for marker:",n,"Available markers:",r?Array.from(r.keys()):"none"),[]}const n=window.wp?.data;if(!n)return console.log("[ACT findByWpBlock] wp.data not available"),[];const r=n.select("core/block-editor");if(!r)return console.log("[ACT findByWpBlock] core/block-editor store not available"),[];const o=r.getBlocks();console.log("[ACT findByWpBlock] Found",o.length,"blocks in editor");let s=null;if("first"===e)s=o[0]?.clientId;else if("last"===e)s=o[o.length-1]?.clientId;else if("selected"===e)s=r.getSelectedBlockClientId();else if(e.startsWith("type:")){const t=e.substring(5).split(":"),n=t[0],r=t[1]?parseInt(t[1],10):0,i=o.filter(e=>e.name===n);console.log("[ACT findByWpBlock] Looking for type:",n,"- found",i.length),s=i[r]?.clientId}else if(e.startsWith("nth:")){const t=parseInt(e.substring(4),10);s=o[t]?.clientId}if(!s)return console.log("[ACT findByWpBlock] No matching block found for:",e),[];console.log("[ACT findByWpBlock] Target clientId:",s);const i=t.querySelector(`[data-block="${s}"]`);return i?(console.log("[ACT findByWpBlock] Found element:",i.tagName),[i]):(console.log("[ACT findByWpBlock] Element not found in DOM"),[])}(e.value,t);default:return[]}}function v(e,t,n){let r=t.weight||50;return e.id&&(r+=20),e.getAttribute("data-testid")&&(r+=15),n?.withinContainer&&b(e,n.withinContainer)&&(r+=10),I(e)&&(r+=5),r}function w(e){if(console.log("[ACT resolveTarget] Starting resolution",e),!e||!e.locators||0===e.locators.length)return console.log("[ACT resolveTarget] No locators provided"),{success:!1,error:"No locators provided"};const t=e.constraints||{};console.log("[ACT resolveTarget] Constraints:",t);const n=t.inEditorIframe||t.withinContainer&&[".editor-styles-wrapper",".block-editor-block-list__layout"].includes(t.withinContainer);console.log("[ACT resolveTarget] shouldSearchIframe:",n);let r=document;if(n){const e=function(){const e=document.querySelector('iframe[name="editor-canvas"]');return e?.contentDocument||null}();if(console.log("[ACT resolveTarget] iframeDoc:",e?"found":"NOT FOUND"),!e)return{success:!1,error:"Editor iframe not found"};r=e}const o=[...e.locators].sort((e,t)=>e.fallback!==t.fallback?e.fallback?1:-1:(t.weight||50)-(e.weight||50)),s=o.filter(e=>!e.fallback),i=o.filter(e=>e.fallback);console.log("[ACT resolveTarget] Trying",s.length,"primary +",i.length,"fallback locators");for(const e of[...s,...i]){let n=R(e,r);if(console.log("[ACT resolveTarget] Locator",e.type,":",e.value.substring(0,50),"-> found",n.length,"raw matches"),!1!==t.visible&&(n=n.filter(I),console.log("[ACT resolveTarget]   After visibility filter:",n.length)),t.withinContainer&&(n=n.filter(e=>b(e,t.withinContainer)),console.log("[ACT resolveTarget]   After container filter:",n.length)),0===n.length)continue;if(1===n.length)return console.log("[ACT resolveTarget] SUCCESS! Found element with",e.type),{success:!0,element:n[0],usedLocator:e};if("number"==typeof t.index&&n[t.index])return{success:!0,element:n[t.index],usedLocator:e};const o=n.map(n=>({element:n,score:v(n,e,t)}));return o.sort((e,t)=>t.score-e.score),{success:!0,element:o[0].element,usedLocator:e}}return console.log("[ACT resolveTarget] FAILED - No matching element found after trying all locators"),{success:!1,error:"No matching element found"}}async function x(e,t=2e3){const n=Date.now();return new Promise(r=>{const o=()=>{const s=document.querySelector(e);s?r(s):Date.now()-n>t?r(null):requestAnimationFrame(o)};o()})}async function k(e,t=2e3){const n=Date.now();return new Promise(r=>{const o=()=>{try{if(e())return void r(!0)}catch{}Date.now()-n>t?r(!1):requestAnimationFrame(o)};o()})}const P=new Map;window.__actInsertedBlocks=P;const O=new Map;let D=0;function L(){P.clear(),O.clear(),D=0,console.log("[ACT clearInsertedBlocks] Cleared all tracking")}function B(e,t,n){O.has(e)||O.set(e,{}),O.get(e)[t]=n}async function N(e){await new Promise(e=>setTimeout(e,100));const t=document.querySelector('iframe[name="editor-canvas"]'),n=t?.contentDocument||document,r=n.querySelector(`[data-block="${e}"]`);if(!r)return console.warn("[ACT focusBlockElement] Block element not found:",e),!1;const o=['[contenteditable="true"]',".block-editor-rich-text__editable","textarea",'input[type="text"]',"input:not([type])"];let s=null;for(const e of o)if(s=r.querySelector(e),s)break;if(s||(s=r),s.scrollIntoView({behavior:"smooth",block:"center"}),s.focus(),"true"===s.getAttribute("contenteditable")){const e=n.getSelection(),t=n.createRange();t.selectNodeContents(s),t.collapse(!1),e?.removeAllRanges(),e?.addRange(t)}return console.log("[ACT focusBlockElement] Focused:",s.tagName,s.className),!0}const U={ensureEditor:async function(){const e=(0,a.select)("core/block-editor");return!!e&&k(()=>{const t=e.getBlocks?.();return void 0!==t})},ensureSidebarOpen:async function(e=null){const t=(0,a.select)("core/edit-post"),n=(0,a.dispatch)("core/edit-post");if(!t||!n){const t=(0,a.select)("core/interface"),n=(0,a.dispatch)("core/interface");if(t&&n){const r=t.getActiveComplementaryArea?.("core/edit-post");return r||await(n.enableComplementaryArea?.("core/edit-post",e||"edit-post/document")),k(()=>!!t.getActiveComplementaryArea?.("core/edit-post"))}return!1}if(t.isEditorSidebarOpened?.()||t.isPluginSidebarOpened?.())return!0;try{return e?await(n.openGeneralSidebar?.(e)):await(n.openGeneralSidebar?.("edit-post/document")),k(()=>t.isEditorSidebarOpened?.())}catch{return!1}},ensureSidebarClosed:async function(){const e=(0,a.select)("core/edit-post"),t=(0,a.dispatch)("core/edit-post");if(!e||!t){const e=(0,a.select)("core/interface"),t=(0,a.dispatch)("core/interface");if(e&&t){const n=e.getActiveComplementaryArea?.("core/edit-post");return n&&await(t.disableComplementaryArea?.("core/edit-post")),k(()=>!e.getActiveComplementaryArea?.("core/edit-post"))}return!1}const n=e.isEditorSidebarOpened?.();if(!n)return!0;try{return await(t.closeGeneralSidebar?.()),k(()=>!e.isEditorSidebarOpened?.())}catch{return!1}},selectSidebarTab:async function(e){const t=(0,a.dispatch)("core/edit-post");if(!t)return!1;const n={document:"edit-post/document",post:"edit-post/document",block:"edit-post/block"}[e]||e;try{return await(t.openGeneralSidebar?.(n)),k(()=>{const e=(0,a.select)("core/edit-post");return e?.getActiveGeneralSidebarName?.()===n})}catch{return!1}},openInserter:async function(){const e=(0,a.select)("core/edit-post"),t=(0,a.dispatch)("core/edit-post");if(e?.isInserterOpened?.())return!0;try{return await(t?.setIsInserterOpened?.(!0)),k(()=>e?.isInserterOpened?.())}catch{const e=document.querySelector('.edit-post-header-toolbar__inserter-toggle, button[aria-label*="inserter"], button[aria-label*="Add block"]');return!!e&&(e.click(),x(".block-editor-inserter__content, .editor-inserter__content").then(e=>!!e))}},closeInserter:async function(){const e=(0,a.select)("core/edit-post"),t=(0,a.dispatch)("core/edit-post");if(!e?.isInserterOpened?.())return!0;try{return await(t?.setIsInserterOpened?.(!1)),k(()=>!e?.isInserterOpened?.())}catch{return!1}},selectBlock:async function(e){const t=(0,a.dispatch)("core/block-editor");if(!t||!e)return!1;try{return await(t.selectBlock?.(e)),k(()=>{const t=(0,a.select)("core/block-editor");return t?.getSelectedBlockClientId?.()===e})}catch{return!1}},focusElement:async function(e){const t=await x(e);if(!t)return!1;try{return t.focus(),document.activeElement===t}catch{return!1}},scrollIntoView:async function(e){const t=await x(e);if(!t)return!1;try{return t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),await new Promise(e=>setTimeout(e,300)),!0}catch{return!1}},openModal:async function(e,t){if(document.querySelector(t))return!0;const n=await x(e);return!!n&&(n.click(),x(t).then(e=>!!e))},closeModal:async function(e){const t=document.querySelector(e);if(!t)return!0;const n=t.querySelector('button[aria-label="Close"], .components-modal__header button, .components-popover__close');return n?(n.click(),k(()=>!document.querySelector(e))):(document.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape",code:"Escape",bubbles:!0})),k(()=>!document.querySelector(e)))},insertBlock:async function(e="core/paragraph",t={},n="act-inserted-block"){console.log("[ACT insertBlock] Called with:",{blockName:e,markerId:n,currentStepIndex:D}),console.log("[ACT insertBlock] insertedBlocks map:",Array.from(P.entries())),console.log("[ACT insertBlock] insertedBlocksByStep:",Array.from(O.entries()));try{const{createBlock:r}=await Promise.resolve().then(o.t.bind(o,997,23)),s=(0,a.dispatch)("core/block-editor"),i=(0,a.select)("core/block-editor");if(!s||!r)return console.warn("[ACT insertBlock] Block editor not available"),!1;const c=function(e,t){const n=O.get(e);return n&&n[t]?n[t]:null}(D,n);if(console.log("[ACT insertBlock] stepClientId from getStepInsertedBlock:",c),c){const e=i.getBlock(c);if(console.log("[ACT insertBlock] existingBlock from store:",e?.name),e)return await s.selectBlock(c),await N(c),console.log("[ACT insertBlock] Reusing step block:",c,"for step:",D),!0;const t=document.querySelector('iframe[name="editor-canvas"]');if((t?.contentDocument||document).querySelector(`[data-block="${c}"]`))return await s.selectBlock(c),await N(c),console.log("[ACT insertBlock] Block still in DOM, reusing:",c),!0;console.log("[ACT insertBlock] Block not in store or DOM, checking for any existing blocks of this type")}if(console.log("[ACT insertBlock] Checking global map for:",n,"has:",P.has(n)),P.has(n)){const e=P.get(n),t=i.getBlock(e);if(console.log("[ACT insertBlock] existingBlock from global map:",t?.name),t)return await s.selectBlock(e),await N(e),B(D,n,e),console.log("[ACT insertBlock] Reusing existing block:",e),!0;const r=document.querySelector('iframe[name="editor-canvas"]');if((r?.contentDocument||document).querySelector(`[data-block="${e}"]`))return await s.selectBlock(e),await N(e),B(D,n,e),console.log("[ACT insertBlock] Block from global map still in DOM:",e),!0}const l=i.getBlocks()||[];console.log("[ACT insertBlock] Checking for existing blocks of type:",e,"found:",l.length,"total blocks"),console.log("[ACT insertBlock] Block names in editor:",l.map(e=>e.name));const u=l.find(t=>t.name===e);if(u)return console.log("[ACT insertBlock] Found existing block of same type:",u.clientId),await s.selectBlock(u.clientId),await N(u.clientId),P.set(n,u.clientId),B(D,n,u.clientId),console.log("[ACT insertBlock] Reusing existing block of type:",e),!0;if(l.length>0){const t=l[l.length-1];console.log("[ACT insertBlock] Considering last block:",t.name,t.clientId);const r=["core/paragraph","core/heading","core/list","core/quote"];if(r.includes(t.name)||r.includes(e))return console.log("[ACT insertBlock] Reusing last text block instead of creating new:",t.clientId),await s.selectBlock(t.clientId),await N(t.clientId),P.set(n,t.clientId),B(D,n,t.clientId),!0}console.log("[ACT insertBlock] No existing block found, creating new one");const d={...t,metadata:{...t.metadata||{},actMarkerId:n}},p=r(e,d),m="";await s.insertBlock(p,void 0,m,!0),P.set(n,p.clientId),B(D,n,p.clientId);const T=await k(()=>{const e=document.querySelector('iframe[name="editor-canvas"]'),t=e?.contentDocument;return!!(t||document).querySelector(`[data-block="${p.clientId}"]`)},3e3);return T&&(await s.selectBlock(p.clientId),await N(p.clientId)),console.log("[ACT insertBlock] Inserted block:",p.clientId,"markerId:",n,"step:",D,"success:",T),T}catch(e){return console.error("[ACT insertBlock] Error:",e),!1}}};async function M(e){const{type:t,params:n={}}=e,r=U[t];if(!r)return{success:!1,error:`Unknown precondition type: ${t}`,type:t};try{let e;switch(t){case"ensureEditor":case"ensureSidebarClosed":case"openInserter":case"closeInserter":e=await r();break;case"ensureSidebarOpen":e=await r(n.sidebar);break;case"selectSidebarTab":e=await r(n.tab);break;case"selectBlock":e=await r(n.clientId);break;case"focusElement":case"scrollIntoView":e=await r(n.selector);break;case"openModal":e=await r(n.trigger,n.modal);break;case"closeModal":e=await r(n.modal);break;case"insertBlock":e=await r(n.blockName||"core/paragraph",n.attributes||{},n.markerId||"act-inserted-block");break;default:e=!1}return{success:e,type:t,error:e?null:`Precondition failed: ${t}`}}catch(e){return{success:!1,type:t,error:`Precondition error: ${e.message}`}}}async function j(e){if(!e||0===e.length)return{success:!0,results:[]};const t=[];let n=!0;for(const r of e){const e=await M(r);t.push(e),e.success||(n=!1)}return{success:n,results:t,failedPreconditions:t.filter(e=>!e.success)}}function F(e,t=0){return new Promise(n=>{let r=null,o=null,s=!1;const i=(e,t=!1)=>{s||(s=!0,r&&clearTimeout(r),o&&clearInterval(o),n({success:e,timedOut:t}))};t>0&&(r=setTimeout(()=>{i(!1,!0)},t));const c=()=>{try{e()&&i(!0)}catch{}};c(),s||(o=setInterval(c,100))})}function V(e,t={}){return new Promise(n=>{let r=!1,o=!1;const{timeout:s=0,gracePeriod:i=300}=t;let c=null;const l=()=>{e.removeEventListener("click",a,!0),e.ownerDocument!==document&&e.ownerDocument.removeEventListener("click",a,!0),c&&clearTimeout(c)},a=t=>{r||(o?(e===t.target||e.contains(t.target))&&(console.log("[ACT watchClickTarget] Click detected on target:",e.tagName),r=!0,l(),n({success:!0,event:"click"})):console.log("[ACT watchClickTarget] Ignoring click during grace period"))};e.addEventListener("click",a,{capture:!0}),e.ownerDocument!==document&&e.ownerDocument.addEventListener("click",a,{capture:!0}),setTimeout(()=>{o=!0,console.log("[ACT watchClickTarget] Armed after grace period, watching:",e.tagName,e.className)},i),s>0&&(c=setTimeout(()=>{r||(r=!0,l(),n({success:!1,timedOut:!0}))},s))})}function q(e,t={}){return new Promise(n=>{let r=!1;const{timeout:o=0,expectedValue:s,attributeName:i=null}=t;let c=null,l=null;const a=()=>{l&&l.disconnect(),e.removeEventListener("input",m),e.removeEventListener("change",T),c&&clearTimeout(c)},u=()=>i?e.getAttribute(i):"value"in e?e.value:e.isContentEditable?e.textContent:"checkbox"===e.type||"radio"===e.type?e.checked:e.textContent,d=u(),p=()=>{r||(()=>{const e=u();return void 0!==s?e===s:e!==d})()&&(r=!0,a(),n({success:!0,event:"valueChanged"}))},m=()=>p(),T=()=>p();e.addEventListener("input",m),e.addEventListener("change",T),l=new MutationObserver(()=>p()),l.observe(e,{attributes:!0,characterData:!0,subtree:!0,childList:!0}),o>0&&(c=setTimeout(()=>{r||(r=!0,a(),n({success:!1,timedOut:!0}))},o))})}function G(e={}){const{storeName:t,selector:n,args:r=[],expectedValue:o,comparator:s="equals",timeout:i=0}=e;return new Promise(e=>{let c=!1,l=null,u=null;const d=()=>{u&&u(),l&&clearTimeout(l)},p=(0,a.select)(t);if(!p||!p[n])return void e({success:!1,error:`Invalid store or selector: ${t}.${n}`});const m=()=>{c||(()=>{try{const e=p[n](...r);switch(s){case"equals":default:return e===o;case"notEquals":return e!==o;case"truthy":return!!e;case"falsy":return!e;case"contains":return(Array.isArray(e)||"string"==typeof e)&&e.includes(o);case"greaterThan":return e>o;case"lessThan":return e<o;case"lengthEquals":return e?.length===o;case"lengthGreaterThan":return e?.length>o}}catch{return!1}})()&&(c=!0,d(),e({success:!0,event:"wpDataChanged"}))};m(),c||(u=(0,a.subscribe)(()=>{m()})),i>0&&(l=setTimeout(()=>{c||(c=!0,d(),e({success:!1,timedOut:!0}))},i))})}function H(e={}){const{timeout:t=0}=e;let n=null,r=null,o=!1;return{promise:new Promise(e=>{n=e,t>0&&(r=setTimeout(()=>{o||(o=!0,e({success:!1,timedOut:!0}))},t))}),confirm:()=>{o||(o=!0,r&&clearTimeout(r),n({success:!0,event:"manual"}))},cancel:()=>{o||(o=!0,r&&clearTimeout(r),n({success:!1,cancelled:!0}))}}}function $(e,t={}){const{timeout:n=0}=t;return F(()=>null!==document.querySelector(e),n).then(e=>({...e,event:e.success?"elementAppeared":null}))}function z(e,t={}){const{timeout:n=0}=t;return F(()=>null===document.querySelector(e),n).then(e=>({...e,event:e.success?"elementDisappeared":null}))}function W(e,t={}){const{timeout:n=0,target:r=document}=t;return new Promise(t=>{let o=!1,s=null;const i=()=>{r.removeEventListener(e,c),s&&clearTimeout(s)},c=n=>{o||(o=!0,i(),t({success:!0,event:e,detail:n.detail}))};r.addEventListener(e,c,{once:!0}),n>0&&(s=setTimeout(()=>{o||(o=!0,i(),t({success:!1,timedOut:!0}))},n))})}const K="admin-coach-tours";function X(){console.log("[ACT TourRunner] Component function called");const[e,t]=(0,l.useState)(null),[n,r]=(0,l.useState)(null),[o,s]=(0,l.useState)(null),[i,c]=(0,l.useState)(!1),[u,d]=(0,l.useState)(null),[p,T]=(0,l.useState)(0),g=(0,l.useRef)(null),f=(0,l.useRef)(null),{isPlaying:E,currentTour:h,currentStep:S,stepIndex:_,totalSteps:I}=(0,a.useSelect)(e=>{const t=e(K),n={isPlaying:t.isPupilMode(),currentTour:t.getCurrentTour(),currentStep:t.getCurrentStep(),stepIndex:t.getCurrentStepIndex()||0,totalSteps:t.getTotalSteps()||0};return console.log("[ACT TourRunner] useSelect:",n),n},[]),{stopTour:b,nextStep:C,previousStep:R,repeatStep:v,markStepComplete:x}=(0,a.useDispatch)(K);(0,l.useEffect)(()=>(g.current||(g.current=new A),()=>{g.current&&(g.current.destroy(),g.current=null)}),[]),(0,l.useEffect)(()=>{if(!E||!S)return g.current&&g.current.clear(),t(null),void L();let e=!0,n=null;const o=f.current;return(async()=>{if(r(null),c(!0),u?.cancel&&u.cancel(),null!==o&&o!==_&&await async function(e){console.log("[ACT onLeaveStep] Leaving step:",e);const t=(0,a.dispatch)("core/block-editor"),n=(0,a.select)("core/block-editor");if(!t||!n)return;const r=n.getSelectedBlockClientId?.();if(r)try{await(t.clearSelectedBlock?.()),console.log("[ACT onLeaveStep] Deselected block:",r)}catch(e){console.warn("[ACT onLeaveStep] Could not deselect block:",e)}}(o),await async function(e){var t;console.log("[ACT onEnterStep] Entering step:",e),D=t=e,console.log("[ACT setCurrentStepIndex]",t)}(_),f.current=_,console.log("[ACT TourRunner] Preconditions for step:",_,S.preconditions),S.preconditions?.length>0){console.log("[ACT TourRunner] Applying",S.preconditions.length,"preconditions");const t=await j(S.preconditions);if(console.log("[ACT TourRunner] Precondition result:",t),!e)return;t.success||console.warn("Some preconditions failed:",t.failedPreconditions)}else console.log("[ACT TourRunner] No preconditions for this step");if(c(!1),S.target){const o=S.recovery?async()=>{await j(S.recovery)}:null,i=await async function(e,t=null){let n=w(e);if(n.success)return n;if(t)try{if(await t(),await new Promise(e=>setTimeout(e,100)),n=w(e),n.success)return{...n,recovered:!0}}catch(e){return{success:!1,error:`Recovery failed: ${e.message}`}}return n}(S.target,o);if(!e)return;i.success?(n=i.element,t(i.element),s({success:!0,usedLocator:i.usedLocator,recovered:i.recovered||!1}),g.current&&g.current.highlight(i.element),i.element.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})):(n=null,t(null),r(i.error),s({success:!1,error:i.error}),g.current&&g.current.clear())}if(S.completion&&n){if(await new Promise(e=>setTimeout(e,100)),!e)return;const t=function(e,t=null){if(!e||!e.type)return H();const{type:n,params:r={}}=e,o=e.timeout||0;switch(n){case"clickTarget":return t?{promise:V(t,{timeout:o}),cancel:()=>{}}:{promise:Promise.resolve({success:!1,error:"No target element for clickTarget"}),cancel:()=>{}};case"domValueChanged":return t?{promise:q(t,{timeout:o,...r}),cancel:()=>{}}:{promise:Promise.resolve({success:!1,error:"No target element for domValueChanged"}),cancel:()=>{}};case"wpData":return{promise:G({timeout:o,...r}),cancel:()=>{}};case"manual":default:return H({timeout:o});case"elementAppear":return{promise:$(r.selector,{timeout:o}),cancel:()=>{}};case"elementDisappear":return{promise:z(r.selector,{timeout:o}),cancel:()=>{}};case"customEvent":return{promise:W(r.eventName,{timeout:o}),cancel:()=>{}}}}(S.completion,n);d(t),t.promise.then(t=>{e&&t.success&&(x(S.id),_<I-1&&setTimeout(()=>{e&&C()},500))})}})(),()=>{e=!1,u?.cancel&&u.cancel()}},[E,S,_,p]);const k=(0,l.useCallback)(()=>{u?.confirm?u.confirm():C()},[u,C]),P=(0,l.useCallback)(()=>{u?.cancel&&u.cancel(),T(e=>e+1),v()},[u,v]),O=(0,l.useCallback)(()=>{u?.cancel&&u.cancel(),L(),f.current=null,b()},[u,b]);if(!E||!h||!S)return null;const B=(0,m.jsx)(y,{step:S,stepIndex:_,totalSteps:I,tourTitle:h.title,targetElement:e,resolutionError:n,isApplyingPreconditions:i,isPaused:!1,onContinue:k,onRepeat:P,onPrevious:R,onNext:C,onPause:()=>{},onResume:()=>{},onStop:O});return(0,l.createPortal)(B,document.body)}const Z={tours:{},toursLoading:!1,toursError:null,currentTourId:null,currentStepIndex:0,mode:null,completionSatisfied:!1,skippedSteps:[],isPickerActive:!1,pickingStepId:null,selectedStepId:null,pendingChanges:!1,tourProgress:{},isRecovering:!1,lastError:null,resolvedTarget:null,resolutionAttempts:0,sidebarOpen:!1,aiDraftLoading:!1,aiDraftError:null,aiDraftResult:null},Q={SET_TOURS_LOADING:"SET_TOURS_LOADING",SET_TOURS_ERROR:"SET_TOURS_ERROR",RECEIVE_TOURS:"RECEIVE_TOURS",RECEIVE_TOUR:"RECEIVE_TOUR",SET_CURRENT_TOUR:"SET_CURRENT_TOUR",START_TOUR:"START_TOUR",END_TOUR:"END_TOUR",SET_CURRENT_STEP:"SET_CURRENT_STEP",NEXT_STEP:"NEXT_STEP",PREVIOUS_STEP:"PREVIOUS_STEP",SKIP_STEP:"SKIP_STEP",REPEAT_STEP:"REPEAT_STEP",SET_MODE:"SET_MODE",SET_COMPLETION_SATISFIED:"SET_COMPLETION_SATISFIED",RESET_COMPLETION:"RESET_COMPLETION",SET_RESOLVED_TARGET:"SET_RESOLVED_TARGET",CLEAR_RESOLVED_TARGET:"CLEAR_RESOLVED_TARGET",SET_RECOVERING:"SET_RECOVERING",INCREMENT_RESOLUTION_ATTEMPTS:"INCREMENT_RESOLUTION_ATTEMPTS",SET_LAST_ERROR:"SET_LAST_ERROR",ACTIVATE_PICKER:"ACTIVATE_PICKER",DEACTIVATE_PICKER:"DEACTIVATE_PICKER",SELECT_STEP:"SELECT_STEP",SET_PENDING_CHANGES:"SET_PENDING_CHANGES",UPDATE_STEP:"UPDATE_STEP",ADD_STEP:"ADD_STEP",DELETE_STEP:"DELETE_STEP",REORDER_STEPS:"REORDER_STEPS",SET_AI_DRAFT_LOADING:"SET_AI_DRAFT_LOADING",SET_AI_DRAFT_ERROR:"SET_AI_DRAFT_ERROR",SET_AI_DRAFT_RESULT:"SET_AI_DRAFT_RESULT",CLEAR_AI_DRAFT:"CLEAR_AI_DRAFT",SET_SIDEBAR_OPEN:"SET_SIDEBAR_OPEN"},Y=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)});function J(e){return{type:Q.SET_TOURS_LOADING,isLoading:e}}function ee(e){return{type:Q.SET_TOURS_ERROR,error:e}}function te(e){return{type:Q.RECEIVE_TOURS,tours:e}}function ne(e){return{type:Q.RECEIVE_TOUR,tour:e}}function*re(e){if(e){try{const t=yield{type:"API_FETCH",request:{path:`/admin-coach-tours/v1/tours/${e}`,method:"GET"}};t&&t.id&&(yield ne(t))}catch(t){console.log("[ACT] Tour not found, creating placeholder for:",e),yield ne({id:e,title:"",steps:[],status:"draft"})}yield{type:Q.SET_CURRENT_TOUR,tourId:e}}else yield{type:Q.SET_CURRENT_TOUR,tourId:null}}function oe(e={}){return{type:"FETCH_TOURS",args:e}}function se(e){return{type:"FETCH_TOUR",tourId:e}}function*ie(e,t){try{const n=yield{type:"SAVE_TOUR",tourId:e,tourData:t};return n?.id&&(yield ne(n)),n}catch(e){throw e}}function*ce(e){try{const t=yield{type:"CREATE_TOUR",data:e};return t?.id&&(yield ne(t)),t}catch(e){throw e}}function*le(e,t){try{const n=yield{type:"UPDATE_TOUR",tourId:e,data:t};return n?.id&&(yield ne(n)),n}catch(e){throw e}}function ae(e,t="pupil"){return{type:Q.START_TOUR,tourId:e,mode:t}}function ue(){return{type:Q.END_TOUR}}function de(){return ue()}function pe(e){return{type:Q.SET_CURRENT_STEP,stepIndex:e}}function me(){return{type:Q.NEXT_STEP}}function Te(){return{type:Q.PREVIOUS_STEP}}function ge(){return{type:Q.SKIP_STEP}}function fe(){return{type:Q.REPEAT_STEP}}function Ee(e){return{type:Q.SET_MODE,mode:e}}function he(e){return{type:Q.SET_COMPLETION_SATISFIED,satisfied:e}}function Se(){return{type:Q.RESET_COMPLETION}}function ye(){return me()}function _e(e){return{type:Q.SET_RESOLVED_TARGET,target:e}}function Ae(){return{type:Q.CLEAR_RESOLVED_TARGET}}function Ie(e){return{type:Q.SET_RECOVERING,isRecovering:e}}function be(){return{type:Q.INCREMENT_RESOLUTION_ATTEMPTS}}function Ce(e){return{type:Q.SET_LAST_ERROR,error:e}}function Re(e=null){return{type:Q.ACTIVATE_PICKER,stepId:e}}function ve(e=null){return Re(e)}function we(){return{type:Q.DEACTIVATE_PICKER}}function xe(){return we()}function ke(e){return{type:Q.SELECT_STEP,stepId:e}}function Pe(e){return{type:Q.SET_PENDING_CHANGES,pending:e}}function*Oe(e,t,n){yield{type:Q.UPDATE_STEP,tourId:e,stepId:t,updates:n}}function*De(e,t={},n=null){const r={id:Y(),order:0,title:"",instruction:"",hint:"",target:{locators:[],constraints:{visible:!0}},preconditions:[],completion:{type:"manual"},recovery:[{action:"reapplyPreconditions",timeout:1e3}],tags:[],version:1,...t};yield{type:Q.ADD_STEP,tourId:e,step:r,index:n}}function*Le(e,t){yield{type:Q.DELETE_STEP,tourId:e,stepId:t}}function*Be(e,t){yield{type:Q.REORDER_STEPS,tourId:e,stepIds:t}}function Ne(e){return{type:Q.SET_AI_DRAFT_LOADING,isLoading:e}}function Ue(e){return{type:Q.SET_AI_DRAFT_ERROR,error:e}}function Me(e){return{type:Q.SET_AI_DRAFT_RESULT,result:e}}function je(){return{type:Q.CLEAR_AI_DRAFT}}function*Fe(e,t){yield Ne(!0),yield Ue(null);try{const n=yield{type:"REQUEST_AI_DRAFT",elementContext:e,postType:t};return yield Me(n),n}catch(e){throw yield Ue(e.message||"Failed to generate AI draft"),e}finally{yield Ne(!1)}}function Ve(e){return{type:Q.SET_SIDEBAR_OPEN,isOpen:e}}function qe(e){return e.tours}const Ge=(0,a.createSelector)(e=>Object.values(e.tours),e=>[e.tours]);function He(e,t){return e.tours[t]||null}function $e(e){return e.toursLoading}function ze(e){return e.toursError}const We=(0,a.createSelector)((e,t)=>Ge(e).filter(e=>e.postTypes&&e.postTypes.includes(t)&&"publish"===e.status),(e,t)=>[e.tours,t]),Ke=(0,a.createSelector)((e,t)=>Ge(e).filter(e=>e.editor===t&&"publish"===e.status),(e,t)=>[e.tours,t]);function Xe(e){return e.currentTourId}function Ze(e){return e.currentTourId?e.tours[e.currentTourId]:null}function Qe(e){return e.currentStepIndex}const Ye=(0,a.createSelector)(e=>{const t=Ze(e);return t&&t.steps&&t.steps[e.currentStepIndex]||null},e=>[e.tours,e.currentTourId,e.currentStepIndex]);function Je(e){const t=Ze(e);return t?.steps?.length||0}function et(e){return e.currentStepIndex<Je(e)-1}function tt(e){return e.currentStepIndex>0}function nt(e){const t=Je(e);return 0===t?0:Math.round((e.currentStepIndex+1)/t*100)}function rt(e){return e.mode}function ot(e){return"educator"===e.mode}function st(e){return"pupil"===e.mode}function it(e){return null!==e.currentTourId&&null!==e.mode}function ct(e){return e.completionSatisfied}function lt(e){return e.skippedSteps}function at(e,t){return e.skippedSteps.includes(t)}function ut(e){return e.resolvedTarget}function dt(e){return e.isRecovering}function pt(e){return e.resolutionAttempts}function mt(e){return e.lastError}function Tt(e){return e.isPickerActive}function gt(e){return e.pickingStepId||null}function ft(e){return e.selectedStepId}const Et=(0,a.createSelector)(e=>{const t=Ze(e);return t&&e.selectedStepId?t.steps.find(t=>t.id===e.selectedStepId):null},e=>[e.tours,e.currentTourId,e.selectedStepId]);function ht(e){return e.pendingChanges}function St(e){return e.aiDraftLoading}function yt(e){return St(e)}function _t(e){return e.aiDraftError}function At(e){return e.aiDraftResult}function It(e){return At(e)}function bt(e){return e.sidebarOpen}const Ct=window.wp.apiFetch;var Rt=o.n(Ct);function*vt(){yield J(!0);try{const e=yield{type:"API_FETCH",request:{path:"/admin-coach-tours/v1/tours",method:"GET"}};yield te(e)}catch(e){yield ee(e.message||"Failed to fetch tours")}}function*wt(e){yield J(!0);try{const t=yield{type:"API_FETCH",request:{path:`/admin-coach-tours/v1/tours/${e}`,method:"GET"}};yield ne(t)}catch(e){yield ee(e.message||"Failed to fetch tour")}}function*xt(e){yield J(!0);try{const t=yield{type:"API_FETCH",request:{path:`/admin-coach-tours/v1/tours?post_type=${e}&editor=block`,method:"GET"}};yield te(t)}catch(e){yield ee(e.message||"Failed to fetch tours")}}const kt={API_FETCH:e=>Rt()(e.request),FETCH_TOUR:e=>Rt()({path:`/admin-coach-tours/v1/tours/${e.tourId}`,method:"GET"}),FETCH_TOURS(e){const t=new URLSearchParams;e.args.postType&&t.append("post_type",e.args.postType),e.args.editor&&t.append("editor",e.args.editor);const n=t.toString(),r="/admin-coach-tours/v1/tours"+(n?`?${n}`:"");return Rt()({path:r,method:"GET"})},SAVE_TOUR:e=>(console.log("[ACT Controls] SAVE_TOUR:",e.tourId,e.tourData),console.log("[ACT Controls] Steps count:",e.tourData?.steps?.length),Rt()({path:`/admin-coach-tours/v1/tours/${e.tourId}`,method:"PUT",data:e.tourData})),CREATE_TOUR:e=>Rt()({path:"/admin-coach-tours/v1/tours",method:"POST",data:e.data}),UPDATE_TOUR:e=>Rt()({path:`/admin-coach-tours/v1/tours/${e.tourId}`,method:"PUT",data:e.data}),REQUEST_AI_DRAFT:e=>Rt()({path:"/admin-coach-tours/v1/ai/generate-draft",method:"POST",data:{elementContext:e.elementContext,postType:e.postType}})},Pt="admin-coach-tours",Ot=(0,a.createReduxStore)(Pt,{reducer:function(e=Z,t){switch(t.type){case Q.SET_TOURS_LOADING:return{...e,toursLoading:t.isLoading};case Q.SET_TOURS_ERROR:return{...e,toursError:t.error,toursLoading:!1};case Q.RECEIVE_TOURS:return{...e,tours:t.tours.reduce((e,t)=>(e[t.id]=t,e),{...e.tours}),toursLoading:!1,toursError:null};case Q.RECEIVE_TOUR:return{...e,tours:{...e.tours,[t.tour.id]:t.tour},toursLoading:!1};case Q.SET_CURRENT_TOUR:return{...e,currentTourId:t.tourId,currentStepIndex:0,mode:t.tourId?"educator":null,selectedStepId:null};case Q.START_TOUR:return{...e,currentTourId:t.tourId,currentStepIndex:0,mode:t.mode||"pupil",completionSatisfied:!1,skippedSteps:[],lastError:null,resolutionAttempts:0};case Q.END_TOUR:return{...e,currentTourId:null,currentStepIndex:0,mode:null,completionSatisfied:!1,resolvedTarget:null,isRecovering:!1,lastError:null};case Q.SET_CURRENT_STEP:return{...e,currentStepIndex:t.stepIndex,completionSatisfied:!1,resolvedTarget:null,resolutionAttempts:0,lastError:null};case Q.NEXT_STEP:{const t=e.tours[e.currentTourId],n=e.currentStepIndex+1;return t&&n<t.steps.length?{...e,currentStepIndex:n,completionSatisfied:!1,resolvedTarget:null,resolutionAttempts:0,lastError:null}:{...e,currentTourId:null,currentStepIndex:0,mode:null,completionSatisfied:!1,resolvedTarget:null}}case Q.PREVIOUS_STEP:return{...e,currentStepIndex:Math.max(0,e.currentStepIndex-1),completionSatisfied:!1,resolvedTarget:null,resolutionAttempts:0};case Q.SKIP_STEP:{const t=e.tours[e.currentTourId],n=t?.steps[e.currentStepIndex],r=e.currentStepIndex+1,o=t&&r<t.steps.length,s=n?[...e.skippedSteps,n.id]:e.skippedSteps;return o?{...e,currentStepIndex:r,skippedSteps:s,completionSatisfied:!1,resolvedTarget:null,resolutionAttempts:0}:{...e,skippedSteps:s,currentTourId:null,currentStepIndex:0,mode:null}}case Q.REPEAT_STEP:return{...e,completionSatisfied:!1,resolvedTarget:null,resolutionAttempts:0,lastError:null,isRecovering:!1};case Q.SET_MODE:return{...e,mode:t.mode};case Q.SET_COMPLETION_SATISFIED:return{...e,completionSatisfied:t.satisfied};case Q.RESET_COMPLETION:return{...e,completionSatisfied:!1};case Q.SET_RESOLVED_TARGET:return{...e,resolvedTarget:t.target,lastError:null};case Q.CLEAR_RESOLVED_TARGET:return{...e,resolvedTarget:null};case Q.SET_RECOVERING:return{...e,isRecovering:t.isRecovering};case Q.INCREMENT_RESOLUTION_ATTEMPTS:return{...e,resolutionAttempts:e.resolutionAttempts+1};case Q.SET_LAST_ERROR:return{...e,lastError:t.error};case Q.ACTIVATE_PICKER:return{...e,isPickerActive:!0,pickingStepId:t.stepId||null};case Q.DEACTIVATE_PICKER:return{...e,isPickerActive:!1,pickingStepId:null};case Q.SELECT_STEP:return{...e,selectedStepId:t.stepId};case Q.SET_PENDING_CHANGES:return{...e,pendingChanges:t.pending};case Q.UPDATE_STEP:{const n=e.tours[t.tourId];if(!n)return e;const r=n.steps.map(e=>e.id===t.stepId?{...e,...t.updates}:e);return{...e,tours:{...e.tours,[t.tourId]:{...n,steps:r}},pendingChanges:!0}}case Q.ADD_STEP:{var n;const r=e.tours[t.tourId];if(!r)return e;const o=[...r.steps],s=null!==(n=t.index)&&void 0!==n?n:o.length;return o.splice(s,0,t.step),o.forEach((e,t)=>{e.order=t}),{...e,tours:{...e.tours,[t.tourId]:{...r,steps:o}},selectedStepId:t.step.id,pendingChanges:!0}}case Q.DELETE_STEP:{const n=e.tours[t.tourId];if(!n)return e;const r=n.steps.filter(e=>e.id!==t.stepId);return r.forEach((e,t)=>{e.order=t}),{...e,tours:{...e.tours,[t.tourId]:{...n,steps:r}},selectedStepId:e.selectedStepId===t.stepId?null:e.selectedStepId,pendingChanges:!0}}case Q.REORDER_STEPS:{const n=e.tours[t.tourId];if(!n)return e;const r={};n.steps.forEach(e=>{r[e.id]=e});const o=t.stepIds.map((e,t)=>({...r[e],order:t}));return{...e,tours:{...e.tours,[t.tourId]:{...n,steps:o}},pendingChanges:!0}}case Q.SET_AI_DRAFT_LOADING:return{...e,aiDraftLoading:t.isLoading,aiDraftError:t.isLoading?null:e.aiDraftError};case Q.SET_AI_DRAFT_ERROR:return{...e,aiDraftError:t.error,aiDraftLoading:!1};case Q.SET_AI_DRAFT_RESULT:return{...e,aiDraftResult:t.result,aiDraftLoading:!1,aiDraftError:null};case Q.CLEAR_AI_DRAFT:return{...e,aiDraftResult:null,aiDraftError:null,aiDraftLoading:!1};case Q.SET_SIDEBAR_OPEN:return{...e,sidebarOpen:t.isOpen};default:return e}},actions:s,selectors:i,resolvers:c,controls:kt,initialState:Z});(0,a.select)(Pt)||(0,a.register)(Ot);const Dt="admin-coach-tours";function Lt(){console.log("[ACT Pupil] Initializing... v3"),console.log("[ACT Pupil] TourRunner:",typeof X,X);const e=document.createElement("div");e.id="admin-coach-tours-pupil",document.body.appendChild(e);try{(0,l.render)((0,m.jsx)(X,{}),e),console.log("[ACT Pupil] TourRunner rendered successfully")}catch(e){console.error("[ACT Pupil] Error rendering TourRunner:",e)}const t=window.top||window,n=new URLSearchParams(t.location.search).get("act_tour");if(console.log("[ACT Pupil] URL search:",t.location.search),console.log("[ACT Pupil] act_tour param:",n),n){const e=parseInt(n,10);console.log("[ACT Pupil] Will fetch and start tour:",e);const t=(0,a.select)(Dt).getTour(e);console.log("[ACT Pupil] Initial tour state:",t);const r=(0,a.subscribe)(()=>{const t=(0,a.select)(Dt),n=t.getTour(e),o=t.isToursLoading();n&&!o&&(console.log("[ACT Pupil] Tour loaded:",n),console.log("[ACT Pupil] Tour steps:",n.steps,"count:",n.steps?.length),r(),(0,a.dispatch)(Dt).startTour(e))});setTimeout(()=>{console.log("[ACT Pupil] Timeout reached, unsubscribing"),r()},1e4)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Lt):Lt()})();